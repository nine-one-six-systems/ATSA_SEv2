---
phase: 02-mfs-compliance-logic
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - models/client.py
  - models/itemized_deduction.py
  - models/__init__.py
  - database/init_db.py
autonomous: true

must_haves:
  truths:
    - "Client record can store deduction method (standard or itemized)"
    - "Itemized deduction data (SALT, mortgage, medical, charitable) can be persisted per client per year"
    - "Expense allocation metadata (who paid what percentage) is stored alongside deduction amounts"
  artifacts:
    - path: "models/client.py"
      provides: "Client.deduction_method column"
      contains: "deduction_method = db.Column"
      min_lines: 25
    - path: "models/itemized_deduction.py"
      provides: "ItemizedDeduction model with Schedule A categories"
      exports: ["ItemizedDeduction"]
      min_lines: 40
    - path: "models/__init__.py"
      provides: "ItemizedDeduction model registration"
      contains: "from models.itemized_deduction import ItemizedDeduction"
  key_links:
    - from: "models/itemized_deduction.py"
      to: "models.client.Client"
      via: "client_id FK"
      pattern: "db\\.ForeignKey\\('clients\\.id'\\)"
    - from: "models/__init__.py"
      to: "models/itemized_deduction.py"
      via: "import and export"
      pattern: "ItemizedDeduction"
---

<objective>
Create database foundation for itemized deductions and MFS compliance tracking by adding deduction method tracking to Client model and creating ItemizedDeduction model for Schedule A data storage.

Purpose: Enable REQ-09 (deduction coordination), REQ-10 (SALT cap enforcement), and REQ-11 (expense allocation) by providing the data structures to track which deduction method each spouse uses and store itemized deduction amounts with allocation metadata.

Output: Database models and migration ready for itemized deduction calculations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/LEARNINGS.md
@.planning/phases/02-mfs-compliance-logic/02-RESEARCH.md

# Existing models to extend/reference
@models/client.py
@models/__init__.py
@database/init_db.py
</context>

<tasks>

<task type="auto">
  <name>Add deduction_method to Client model</name>
  <files>models/client.py</files>
  <action>
Add deduction_method column to Client model after filing_status field (around line 15):

```python
deduction_method = db.Column(db.Text, default='standard', nullable=False)  # 'standard' or 'itemized'
```

Reasoning: Phase 1 only implemented standard deduction path. This field tracks which method each spouse uses, enabling REQ-09 deduction coordination validation. Default to 'standard' to match Phase 1 behavior. NOT NULL constraint ensures valid state.

Run migration to add column to existing clients:
```bash
cd /Users/samueledwards/ATSA_SEv2
python -c "
from app import app
from models import db, Client
with app.app_context():
    # Add column if not exists (SQLite alter table)
    try:
        db.session.execute(db.text('ALTER TABLE clients ADD COLUMN deduction_method TEXT DEFAULT \\'standard\\' NOT NULL'))
        db.session.commit()
        print('Added deduction_method column')
    except Exception as e:
        if 'duplicate column name' in str(e).lower():
            print('Column already exists')
        else:
            raise
"
```
  </action>
  <verify>
```bash
cd /Users/samueledwards/ATSA_SEv2
python -c "from app import app; from models import Client; import sys; sys.exit(0 if hasattr(Client, 'deduction_method') else 1)"
```
Exit code 0 confirms attribute exists.

Check database schema:
```bash
sqlite3 instance/atsa.db ".schema clients" | grep deduction_method
```
Should show deduction_method column.
  </verify>
  <done>Client model has deduction_method column, existing records default to 'standard', model attribute accessible via Client.deduction_method</done>
</task>

<task type="auto">
  <name>Create ItemizedDeduction model</name>
  <files>models/itemized_deduction.py</files>
  <action>
Create new file models/itemized_deduction.py following the pattern from models/joint_analysis.py (Phase 1).

Model structure:
- Table name: itemized_deductions
- Primary key: id (Integer, autoincrement)
- Foreign keys: client_id -> clients.id (nullable=False)
- Fields for Schedule A categories:
  - tax_year (Integer, nullable=False) - enables multi-year tracking
  - medical_expenses (Float, default=0) - total medical before 7.5% AGI threshold
  - state_local_taxes (Float, default=0) - raw SALT before cap
  - mortgage_interest (Float, default=0) - home mortgage interest
  - charitable_contributions (Float, default=0) - cash + non-cash donations
- Allocation metadata: allocation_metadata (Text, nullable=True) - JSON string storing expense allocation rules
- Timestamps: created_at, updated_at (DateTime)

Example allocation_metadata format:
```json
{
  "mortgage_interest": {"allocation": "both", "taxpayer_pct": 60, "spouse_pct": 40},
  "state_local_taxes": {"allocation": "joint", "taxpayer_pct": 50, "spouse_pct": 50}
}
```

Add to_dict() method for API serialization (follow AnalysisSummary pattern from models/analysis.py lines 27-54).

Critical: Use Float for dollar amounts (matches existing pattern in Client, AnalysisResult). JSON parsing for allocation_metadata happens in service layer, model just stores text.
  </action>
  <verify>
```bash
cd /Users/samueledwards/ATSA_SEv2
python -c "from models.itemized_deduction import ItemizedDeduction; import sys; sys.exit(0 if hasattr(ItemizedDeduction, '__tablename__') and ItemizedDeduction.__tablename__ == 'itemized_deductions' else 1)"
```
Exit code 0 confirms model loads and table name correct.
  </verify>
  <done>ItemizedDeduction model file exists with Schedule A fields, allocation_metadata JSON storage, and to_dict() serialization method</done>
</task>

<task type="auto">
  <name>Register ItemizedDeduction model and create tables</name>
  <files>models/__init__.py, database/init_db.py</files>
  <action>
Register new model in models/__init__.py:
1. Add import after other model imports (around line 8): `from models.itemized_deduction import ItemizedDeduction`
2. Add to __all__ list: `'ItemizedDeduction'`

Follow existing pattern from JointAnalysisSummary registration (added in Phase 1).

Create database tables by running db.create_all():
```bash
cd /Users/samueledwards/ATSA_SEv2
python -c "
from app import app
from models import db
with app.app_context():
    db.create_all()
    print('Tables created')
"
```

No need to modify init_db.py — it already calls db.create_all() (verified in Phase 1). The model registration in __init__.py is sufficient for SQLAlchemy to discover and create tables.
  </action>
  <verify>
```bash
cd /Users/samueledwards/ATSA_SEv2
# Verify model imports
python -c "from models import ItemizedDeduction; print('ItemizedDeduction imported successfully')"

# Verify table exists
sqlite3 instance/atsa.db ".tables" | grep itemized_deductions
```
Both commands succeed confirms registration and table creation.
  </verify>
  <done>ItemizedDeduction model is registered in models/__init__.py, exported in __all__, and itemized_deductions table exists in database with all columns</done>
</task>

</tasks>

<verification>
Final verification checks:

1. Client model has deduction_method column defaulting to 'standard'
2. ItemizedDeduction model exists with medical_expenses, state_local_taxes, mortgage_interest, charitable_contributions, allocation_metadata fields
3. Database tables exist: `sqlite3 instance/atsa.db ".schema itemized_deductions"` shows full schema
4. Model imports work: `from models import Client, ItemizedDeduction` succeeds
5. Existing clients have deduction_method='standard' (backward compatibility)
</verification>

<success_criteria>
1. Any Python code can import ItemizedDeduction and create records with Schedule A amounts
2. Client records store deduction_method ('standard' or 'itemized') with 'standard' as default
3. ItemizedDeduction records can store allocation_metadata as JSON text and retrieve it
4. Database schema includes itemized_deductions table with all required columns and FK to clients
5. No errors when running `db.create_all()` — idempotent table creation works
</success_criteria>

<output>
After completion, create `.planning/phases/02-mfs-compliance-logic/02-01-SUMMARY.md`
</output>
