---
phase: 02-mfs-compliance-logic
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - services/itemized_deduction_service.py
autonomous: true

must_haves:
  truths:
    - "SALT deduction is capped at $20,000 per MFS spouse (2026), not $40,400"
    - "MFJ SALT deduction is capped at $40,400 with income phase-out above $505k MAGI"
    - "Medical expenses are only deductible above 7.5% of AGI threshold"
    - "Shared expenses can be allocated by percentage (60/40, 100/0, 50/50)"
    - "Total itemized deductions are compared to standard deduction, higher amount used"
  artifacts:
    - path: "services/itemized_deduction_service.py"
      provides: "Itemized deduction calculation with SALT cap and allocation logic"
      exports: ["ItemizedDeductionService"]
      min_lines: 200
  key_links:
    - from: "services/itemized_deduction_service.py"
      to: "models.ItemizedDeduction"
      via: "query itemized deduction data"
      pattern: "ItemizedDeduction\\.query"
    - from: "services/itemized_deduction_service.py"
      to: "services.TaxCalculator"
      via: "standard deduction lookup for comparison"
      pattern: "TaxCalculator\\.get_standard_deduction"
---

<objective>
Implement itemized deduction calculation logic with IRS compliance rules: SALT cap by filing status with MAGI phase-out, medical expense threshold (7.5% AGI), and shared expense allocation for MFS.

Purpose: Enforce REQ-10 (SALT cap: $20k MFS per spouse, $40.4k MFJ) and REQ-11 (expense allocation) by calculating itemized deductions according to 2026 IRS rules including One Big Beautiful Bill Act (OBBBA) SALT cap changes.

Output: Service layer methods that calculate itemized deductions correctly for all filing statuses, ready for integration into JointAnalysisService.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-mfs-compliance-logic/02-RESEARCH.md
@.planning/LEARNINGS.md

# Prior plan output
@.planning/phases/02-mfs-compliance-logic/02-01-SUMMARY.md

# Existing services to reference
@services/tax_calculator.py
@services/joint_analysis_service.py
@models/itemized_deduction.py
@models/client.py
</context>

<tasks>

<task type="auto">
  <name>Create ItemizedDeductionService with SALT cap calculation</name>
  <files>services/itemized_deduction_service.py</files>
  <action>
Create new file services/itemized_deduction_service.py with ItemizedDeductionService class.

**Method 1: calculate_salt_deduction(state_local_taxes, filing_status, magi, tax_year=2026)**

Implements OBBBA 2026 SALT cap rules (REQ-10):
- MFJ: $40,400 base cap, phases out above $505k MAGI to $10k floor
- MFS: $20,000 base cap per spouse, phases out above $250k MAGI to $5k floor
- Single: $40,400 base cap, same phase-out as MFJ
- HOH: $40,400 base cap, same phase-out as MFJ

Phase-out formula: Reduce $0.30 per $1 over threshold, floor at minimum cap.

Reference implementation from RESEARCH.md lines 142-192 (Pattern 2).

Returns dict with:
```python
{
    'raw_salt': float,          # Original amount paid
    'cap_applied': float,       # Effective cap after phase-out
    'deduction_allowed': float, # min(raw_salt, cap_applied)
    'capped_amount': float,     # Amount lost to cap
    'phaseout_applied': bool    # True if MAGI exceeds threshold
}
```

Critical: Use exact filing status values ('married_joint', 'married_separate', 'single', 'head_of_household') matching TaxCalculator pattern. Do NOT use 'married' ambiguous value.

For tax years != 2026, use pre-OBBBA caps ($10k MFJ, $5k MFS) with no phase-out.

**Method 2: allocate_shared_expense(expense_type, total_amount, allocation_method, taxpayer_pct=None)**

Implements IRS allocation rules (REQ-11):
- 'taxpayer': 100% to taxpayer, 0% to spouse
- 'spouse': 0% to taxpayer, 100% to spouse
- 'both': Custom split by taxpayer_pct (must sum to 100)
- 'joint': 50/50 split (default for joint payment from joint account)

Reference implementation from RESEARCH.md lines 199-262 (Pattern 3).

Returns dict with taxpayer_amount, spouse_amount, taxpayer_pct, spouse_pct, method.

Validation: taxpayer_pct must be 0-100, raises ValueError if invalid.

**Method 3: calculate_itemized_deductions(client_id, tax_year=2026)**

Main calculation method:
1. Query ItemizedDeduction record for client_id + tax_year
2. Get client's AGI (from AnalysisResult or calculate from income)
3. Calculate medical deduction: max(0, medical_expenses - AGI * 0.075)
4. Calculate SALT deduction with cap (call calculate_salt_deduction with client's MAGI)
5. Get mortgage interest and charitable (no caps, use as-is)
6. Sum itemized total
7. Get standard deduction for comparison (TaxCalculator.get_standard_deduction)
8. Return higher of itemized or standard

Reference implementation from RESEARCH.md lines 402-475 (Code Example).

Returns dict with:
```python
{
    'use_itemized': bool,               # True if itemized > standard
    'itemized_total': float,            # Sum of all itemized deductions
    'standard_deduction': float,        # Standard deduction for filing status
    'benefit_vs_standard': float,       # itemized - standard (negative if standard better)
    'breakdown': {
        'medical_expenses': {
            'raw': float,
            'threshold': float,         # 7.5% of AGI
            'deductible': float         # Amount above threshold
        },
        'state_local_taxes': {
            'raw': float,
            'cap': float,
            'deductible': float,
            'capped_amount': float
        },
        'mortgage_interest': float,
        'charitable_contributions': float
    }
}
```

If no ItemizedDeduction record exists for client+year, return use_itemized=False with standard_deduction only (client hasn't entered itemized data).

Use Decimal for calculations, round to 2 decimal places for money amounts (follows existing TaxCalculator pattern).

Import from existing modules: Client, ItemizedDeduction from models; TaxCalculator from services; json for allocation_metadata parsing.
  </action>
  <verify>
```bash
cd /Users/samueledwards/ATSA_SEv2
# Verify service imports
python -c "from services.itemized_deduction_service import ItemizedDeductionService; print('Service loaded')"

# Test SALT cap calculation (unit test)
python -c "
from services.itemized_deduction_service import ItemizedDeductionService

# Test MFS cap at $20k
result = ItemizedDeductionService.calculate_salt_deduction(
    state_local_taxes=60000,
    filing_status='married_separate',
    magi=200000,  # Below phase-out threshold
    tax_year=2026
)
assert result['cap_applied'] == 20000, f'Expected 20000, got {result[\"cap_applied\"]}'
assert result['deduction_allowed'] == 20000, 'Should cap at 20k'
print('MFS SALT cap test passed')

# Test MFJ cap at $40,400
result = ItemizedDeductionService.calculate_salt_deduction(
    state_local_taxes=60000,
    filing_status='married_joint',
    magi=400000,  # Below phase-out threshold
    tax_year=2026
)
assert result['cap_applied'] == 40400, f'Expected 40400, got {result[\"cap_applied\"]}'
print('MFJ SALT cap test passed')

# Test phase-out for high income MFS
result = ItemizedDeductionService.calculate_salt_deduction(
    state_local_taxes=60000,
    filing_status='married_separate',
    magi=400000,  # $150k over $250k threshold
    tax_year=2026
)
# Reduction: 150000 * 0.30 = 45000, cap reduced from 20000 to floor of 5000
assert result['cap_applied'] == 5000, f'Expected 5000 floor, got {result[\"cap_applied\"]}'
print('SALT phase-out test passed')

print('All SALT cap tests passed')
"

# Test expense allocation
python -c "
from services.itemized_deduction_service import ItemizedDeductionService

# Test 60/40 split
result = ItemizedDeductionService.allocate_shared_expense(
    expense_type='mortgage_interest',
    total_amount=24000,
    allocation_method='both',
    taxpayer_pct=60
)
assert result['taxpayer_amount'] == 14400, 'Expected 60% = 14400'
assert result['spouse_amount'] == 9600, 'Expected 40% = 9600'
print('Allocation test passed')
"
```
All tests must pass without assertion errors.
  </verify>
  <done>ItemizedDeductionService exists with three methods: calculate_salt_deduction enforces 2026 OBBBA caps ($20k MFS, $40.4k MFJ) with MAGI phase-out, allocate_shared_expense handles custom percentage splits, calculate_itemized_deductions returns total itemized deductions vs standard deduction comparison with full breakdown</done>
</task>

</tasks>

<verification>
Final verification checks:

1. SALT cap calculation returns $20,000 for MFS, $40,400 for MFJ (2026 tax year)
2. SALT phase-out reduces cap for high MAGI (test with $400k MAGI MFS â†’ $5k floor)
3. Medical expense threshold is 7.5% of AGI
4. Expense allocation supports taxpayer/spouse/both/joint methods
5. calculate_itemized_deductions compares to standard deduction, returns higher amount
6. Service follows existing patterns (Decimal math, filing_status exact match, TaxCalculator integration)
</verification>

<success_criteria>
1. California MFS couple with $60k SALT sees $20k deduction per spouse (not $40,400)
2. High-income MFS filer ($400k MAGI) sees SALT cap reduced from $20k to $5k floor
3. Mortgage interest of $24k allocated 60/40 returns $14,400 taxpayer, $9,600 spouse
4. Medical expenses below 7.5% AGI threshold result in $0 medical deduction
5. If itemized total < standard deduction, use_itemized returns False and standard_deduction value used
</success_criteria>

<output>
After completion, create `.planning/phases/02-mfs-compliance-logic/02-02-SUMMARY.md`
</output>
