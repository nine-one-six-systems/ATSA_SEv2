---
phase: 03-split-screen-ui
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - static/js/joint_analysis.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Tax professional selects two linked spouses and clicks Load Analysis to see their data"
    - "Dragging the divider between panels resizes them smoothly"
    - "Each spouse panel shows income source breakdown at the top without drilling into details"
    - "Comparison section shows MFJ vs MFS cards with recommendation and dollar difference"
    - "Three-column table shows line-by-line breakdown (gross income through tax liability)"
    - "Layout stacks vertically on mobile and Split.js gutter hides"
  artifacts:
    - path: "static/js/joint_analysis.js"
      provides: "Interactive split-screen behavior"
      exports: ["loadJointAnalysis", "displaySpouseSummary", "displayComparison", "initSplit"]
      min_lines: 200
  key_links:
    - from: "static/js/joint_analysis.js"
      to: "/api/joint-analysis/{id1}/{id2}"
      via: "fetch API call"
      pattern: "fetch.*joint-analysis"
    - from: "static/js/joint_analysis.js"
      to: "templates/joint_analysis.html"
      via: "DOM manipulation"
      pattern: "getElementById.*spouse1-content"
---

<objective>
Implement all JavaScript functionality for the joint analysis split-screen page: client selection, API integration, Split.js resizable panes, spouse panel rendering with income breakdowns, and MFJ vs MFS comparison display.

Purpose: Make the split-screen view fully interactive, enabling tax professionals to load joint analysis data, compare filing statuses, and resize panes to focus on the information they need.

Output: Fully functional joint_analysis.js that connects template to API, renders spouse summaries with income breakdowns, displays comparison cards and table, and handles responsive behavior.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-split-screen-ui/03-RESEARCH.md
@.planning/phases/03-split-screen-ui/03-01-SUMMARY.md

# API response structure reference
@services/joint_analysis_service.py
@routes/joint_analysis.py

# Existing JS patterns to follow
@static/js/analysis.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create joint_analysis.js with Split.js initialization and client loading</name>
  <files>static/js/joint_analysis.js</files>
  <action>
Create new JavaScript file following existing analysis.js patterns.

**Core structure:**
```javascript
// Joint Analysis functionality
const API_BASE = '/api';
let splitInstance = null;

document.addEventListener('DOMContentLoaded', async () => {
    // Load linked spouse pairs for dropdowns
    await loadLinkedClients();

    // Initialize Split.js for desktop
    initSplit();

    // Handle window resize for responsive Split.js
    window.addEventListener('resize', debounce(handleResize, 150));

    // Check URL parameters for pre-selected spouses
    const urlParams = new URLSearchParams(window.location.search);
    const spouse1Id = urlParams.get('spouse1_id');
    const spouse2Id = urlParams.get('spouse2_id');

    if (spouse1Id && spouse2Id) {
        document.getElementById('spouse1-select').value = spouse1Id;
        document.getElementById('spouse2-select').value = spouse2Id;
        await loadJointAnalysis();
    }
});
```

**Implement these functions:**

1. `loadLinkedClients()` - Fetch clients and populate both dropdowns, showing only clients with spouse_id set (linked spouses)

2. `initSplit()` - Initialize Split.js only on desktop (>768px):
   - Create Split instance with ['#spouse1-panel', '#spouse2-panel']
   - Options: sizes [50,50], minSize 280, gutterSize 10, cursor 'col-resize'
   - Save sizes to localStorage on dragEnd
   - Restore sizes from localStorage if available

3. `handleResize()` - Destroy/recreate Split.js based on viewport width:
   - If width <= 768 and splitInstance exists: destroy it
   - If width > 768 and splitInstance is null: create it

4. `debounce(fn, delay)` - Standard debounce utility function

5. `loadJointAnalysis()` - Main function triggered by Load Analysis button:
   - Get spouse IDs from dropdowns
   - Validate both selected
   - Show loading state
   - Fetch from `/api/joint-analysis/${spouse1Id}/${spouse2Id}`
   - Handle errors with showError()
   - On success: call displaySpouseSummary() twice and displayComparison()

**Event binding:**
```javascript
// Bind click handler for Load Analysis button
document.getElementById('load-analysis-btn').addEventListener('click', loadJointAnalysis);
```

**Important patterns to follow from analysis.js:**
- Use async/await for API calls
- Check response.ok before parsing JSON
- Use try/catch with console.error for debugging
- Show user-friendly errors via showError()
  </action>
  <verify>
- File exists at static/js/joint_analysis.js
- Contains initSplit() with Split.js initialization
- Contains loadLinkedClients() with fetch to /api/clients
- Contains loadJointAnalysis() with fetch to /api/joint-analysis
- Responsive handling with handleResize()
  </verify>
  <done>
JavaScript file created with:
- Split.js initialization with localStorage persistence
- Responsive destroy/recreate at 768px breakpoint
- Client dropdown population
- URL parameter detection for direct links
- loadJointAnalysis() API integration
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement spouse panel rendering with income breakdown (REQ-19)</name>
  <files>static/js/joint_analysis.js</files>
  <action>
Add these functions to joint_analysis.js:

**displaySpouseSummary(panelId, data, client):**
```javascript
function displaySpouseSummary(panelId, data, client) {
    // panelId: 'spouse1' or 'spouse2'
    // data: { summary: {...}, strategies: [...] } from API result
    // client: { id, first_name, last_name } for display name

    const nameEl = document.getElementById(`${panelId}-name`);
    const contentEl = document.getElementById(`${panelId}-content`);

    if (!data || !data.summary) {
        contentEl.innerHTML = '<p class="loading">No data available</p>';
        return;
    }

    const summary = data.summary;
    const fullName = `${client.first_name} ${client.last_name}`;
    nameEl.textContent = fullName;

    // Build income sources breakdown (REQ-19)
    const incomeSources = summary.income_sources || [];
    const incomeHtml = incomeSources.length > 0
        ? incomeSources.map(source => `
            <div class="income-item">
                <span class="income-label">${source.source}</span>
                <span class="income-amount">$${formatCurrency(source.amount)}</span>
            </div>
        `).join('')
        : '<div class="income-item"><span>No detailed income sources</span></div>';

    contentEl.innerHTML = `
        <div class="income-breakdown">
            <h4>Income Sources</h4>
            ${incomeHtml}
            <div class="income-total">
                <span>Total Income</span>
                <span>$${formatCurrency(summary.total_income)}</span>
            </div>
        </div>

        <div class="spouse-summary-grid">
            <div class="summary-card">
                <div class="summary-label">AGI</div>
                <div class="summary-value">$${formatCurrency(summary.adjusted_gross_income)}</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Taxable Income</div>
                <div class="summary-value">$${formatCurrency(summary.taxable_income)}</div>
            </div>
            <div class="summary-card ${summary.tax_owed > 0 ? 'owed' : ''}">
                <div class="summary-label">Tax Liability</div>
                <div class="summary-value">$${formatCurrency(summary.total_tax)}</div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Effective Rate</div>
                <div class="summary-value">${summary.effective_tax_rate?.toFixed(2) || '0.00'}%</div>
            </div>
        </div>
    `;
}
```

**Helper functions:**
```javascript
function formatCurrency(amount) {
    if (amount === null || amount === undefined) return '0.00';
    return Number(amount).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function showError(message) {
    // Check if error element already exists
    let errorDiv = document.querySelector('.error-message');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.className = 'error error-message';
        document.body.insertBefore(errorDiv, document.body.firstChild);
    }
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 5000);
}

function showSuccess(message) {
    let successDiv = document.querySelector('.success-message');
    if (!successDiv) {
        successDiv = document.createElement('div');
        successDiv.className = 'success success-message';
        document.body.insertBefore(successDiv, document.body.firstChild);
    }
    successDiv.textContent = message;
    successDiv.style.display = 'block';
    setTimeout(() => {
        successDiv.style.display = 'none';
    }, 3000);
}
```

**Update loadJointAnalysis() to call displaySpouseSummary:**
After successful API response, need to also fetch client details for names:
```javascript
// Inside loadJointAnalysis() after getting result:
const [client1Resp, client2Resp] = await Promise.all([
    fetch(`${API_BASE}/clients/${spouse1Id}`),
    fetch(`${API_BASE}/clients/${spouse2Id}`)
]);
const client1 = await client1Resp.json();
const client2 = await client2Resp.json();

displaySpouseSummary('spouse1', result.spouse1, client1);
displaySpouseSummary('spouse2', result.spouse2, client2);
```

Note: The API response is wrapped in `{ result: {...} }` per routes/joint_analysis.py line 42, so extract with `result.result.spouse1` etc.
  </action>
  <verify>
- displaySpouseSummary() function exists
- Income breakdown HTML generated with income_sources array
- Summary cards show AGI, Taxable Income, Tax Liability, Effective Rate
- formatCurrency() helper handles null/undefined
- Client names displayed in panel headers
  </verify>
  <done>
Spouse panel rendering implemented:
- Income sources breakdown shows source name and amount (REQ-19)
- Summary cards display key tax figures
- Client names appear in panel headers
- Proper currency formatting throughout
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement comparison section with MFJ vs MFS display (REQ-18, REQ-20)</name>
  <files>static/js/joint_analysis.js</files>
  <action>
Add displayComparison() function to joint_analysis.js:

```javascript
function displayComparison(mfj, mfs1, mfs2, comparison) {
    const comparisonDiv = document.getElementById('comparison-content');

    if (!mfj || !comparison) {
        comparisonDiv.innerHTML = '<p class="loading">No comparison data available</p>';
        return;
    }

    // Calculate MFS combined tax
    const mfsCombinedTax = (mfs1?.total_tax || 0) + (mfs2?.total_tax || 0);
    const recommendedStatus = comparison.recommended_status || 'MFJ';
    const savingsAmount = comparison.savings_amount || 0;
    const reason = comparison.reason || '';

    // Build comparison notes if available
    const notes = comparison.notes || [];
    const notesHtml = notes.length > 0
        ? `<div class="comparison-notes">
            <h4>Analysis Notes</h4>
            <ul>
                ${notes.map(note => `<li><strong>${note.type}:</strong> ${note.message}</li>`).join('')}
            </ul>
           </div>`
        : '';

    comparisonDiv.innerHTML = `
        <!-- REQ-18: Comparison cards with recommendation -->
        <div class="comparison-cards">
            <div class="summary-card ${recommendedStatus === 'MFJ' ? 'refund' : ''}">
                <div class="summary-label">Married Filing Jointly (MFJ)</div>
                <div class="summary-value">$${formatCurrency(mfj.total_tax)}</div>
                ${recommendedStatus === 'MFJ' ? '<span class="recommendation-badge">Recommended</span>' : ''}
            </div>
            <div class="summary-card ${recommendedStatus === 'MFS' ? 'refund' : ''}">
                <div class="summary-label">Married Filing Separately (MFS)</div>
                <div class="summary-value">$${formatCurrency(mfsCombinedTax)}</div>
                <div class="summary-sublabel">Combined: Spouse 1 + Spouse 2</div>
                ${recommendedStatus === 'MFS' ? '<span class="recommendation-badge">Recommended</span>' : ''}
            </div>
            <div class="summary-card ${savingsAmount > 0 ? 'refund' : ''}">
                <div class="summary-label">Potential Savings</div>
                <div class="summary-value">$${formatCurrency(savingsAmount)}</div>
                <div class="savings-note">${reason}</div>
            </div>
        </div>

        ${notesHtml}

        <!-- REQ-20: Three-column line-by-line breakdown -->
        <h4>Filing Status Comparison Report</h4>
        <table class="comparison-table">
            <thead>
                <tr>
                    <th>Line Item</th>
                    <th>MFJ Total</th>
                    <th>MFS Spouse 1</th>
                    <th>MFS Spouse 2</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Gross Income</td>
                    <td>$${formatCurrency(mfj.combined_income)}</td>
                    <td>$${formatCurrency(mfs1?.income)}</td>
                    <td>$${formatCurrency(mfs2?.income)}</td>
                </tr>
                <tr>
                    <td>Adjusted Gross Income (AGI)</td>
                    <td>$${formatCurrency(mfj.agi)}</td>
                    <td>$${formatCurrency(mfs1?.agi)}</td>
                    <td>$${formatCurrency(mfs2?.agi)}</td>
                </tr>
                <tr>
                    <td>Standard Deduction</td>
                    <td>$${formatCurrency(mfj.standard_deduction)}</td>
                    <td>$${formatCurrency(mfs1?.standard_deduction)}</td>
                    <td>$${formatCurrency(mfs2?.standard_deduction)}</td>
                </tr>
                <tr>
                    <td>Taxable Income</td>
                    <td>$${formatCurrency(mfj.taxable_income)}</td>
                    <td>$${formatCurrency(mfs1?.taxable_income)}</td>
                    <td>$${formatCurrency(mfs2?.taxable_income)}</td>
                </tr>
                <tr class="highlight">
                    <td>Total Tax Liability</td>
                    <td>$${formatCurrency(mfj.total_tax)}</td>
                    <td>$${formatCurrency(mfs1?.total_tax)}</td>
                    <td>$${formatCurrency(mfs2?.total_tax)}</td>
                </tr>
                <tr class="highlight">
                    <td>Effective Tax Rate</td>
                    <td>${(mfj.effective_rate || 0).toFixed(2)}%</td>
                    <td>${(mfs1?.effective_rate || 0).toFixed(2)}%</td>
                    <td>${(mfs2?.effective_rate || 0).toFixed(2)}%</td>
                </tr>
            </tbody>
        </table>
    `;
}
```

**Update loadJointAnalysis() to call displayComparison:**
```javascript
// After displaying spouse summaries, call:
displayComparison(
    result.result.mfj,
    result.result.mfs_spouse1,
    result.result.mfs_spouse2,
    result.result.comparison
);
```

**Add sublabel CSS to style.css if needed:**
```css
.summary-sublabel {
    font-size: 0.8rem;
    color: #666;
    margin-top: 0.25rem;
}
```
  </action>
  <verify>
- displayComparison() function exists
- Three comparison cards rendered (MFJ, MFS, Savings)
- Recommendation badge shows on recommended filing status
- Four-column table with line items present
- Effective tax rates displayed with % symbol
- Notes section rendered if comparison.notes has entries
  </verify>
  <done>
Comparison section fully implemented:
- Three cards showing MFJ tax, MFS combined tax, savings amount (REQ-18)
- Recommendation badge highlights recommended status
- Reason text explains the recommendation
- Comparison notes displayed when available
- Line-by-line breakdown table (REQ-20) with gross income, AGI, deductions, taxable income, tax liability, effective rate
  </done>
</task>

</tasks>

<verification>
1. Start Flask app: `python app.py`
2. Navigate to http://localhost:5555/joint-analysis.html
3. Select two linked spouse clients from dropdowns (must have existing linked clients in database)
4. Click "Load Analysis" button
5. Verify:
   - Both spouse panels populate with income breakdown and summary cards
   - Spouse names appear in panel headers
   - Comparison section shows three cards (MFJ, MFS, Savings)
   - Recommendation badge appears on recommended status
   - Line-by-line comparison table shows all rows
6. Drag the divider between panels - should resize smoothly
7. Resize browser to <768px:
   - Panels should stack vertically
   - Gutter should disappear
   - Table should be horizontally scrollable
8. Direct link test: Navigate to /joint-analysis.html?spouse1_id=1&spouse2_id=2
   - Should auto-load analysis for those IDs
</verification>

<success_criteria>
1. Split.js initializes on desktop, destroys on mobile (<768px)
2. Split sizes persist in localStorage across page reloads
3. Client dropdowns populate with linked spouse pairs
4. API call to /api/joint-analysis/{id1}/{id2} returns data and displays correctly
5. Income breakdown shows per-spouse income sources (REQ-19)
6. Comparison cards show MFJ vs MFS with recommendation (REQ-18)
7. Line-by-line table shows all tax calculation steps (REQ-20)
8. Error handling shows user-friendly messages
9. URL parameters allow direct linking to specific spouse pairs
</success_criteria>

<output>
After completion, create `.planning/phases/03-split-screen-ui/03-02-SUMMARY.md`
</output>
