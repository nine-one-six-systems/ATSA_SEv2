---
phase: 04-strategies-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - routes/clients.py
  - templates/clients.html
  - static/js/clients.js
autonomous: true

must_haves:
  truths:
    - "User can click 'Create Married Couple' button on clients page"
    - "User sees two-column form for both spouse details"
    - "On submit, both clients are created and linked bidirectionally"
    - "After creation, user is redirected to joint analysis page with spouses pre-selected"
  artifacts:
    - path: "routes/clients.py"
      provides: "POST /api/clients/create-couple endpoint"
      contains: "create_couple"
    - path: "templates/clients.html"
      provides: "Create Married Couple button and modal"
      contains: "createCoupleModal"
    - path: "static/js/clients.js"
      provides: "createCouple() function and modal handlers"
      contains: "createCouple"
  key_links:
    - from: "static/js/clients.js"
      to: "/api/clients/create-couple"
      via: "fetch POST on form submit"
      pattern: "fetch.*create-couple"
    - from: "routes/clients.py"
      to: "db.session"
      via: "create two Client records with bidirectional spouse_id"
      pattern: "spouse1\\.spouse_id.*spouse2"
---

<objective>
Create streamlined spouse linking workflow with "Create Married Couple" functionality.

Purpose: Currently users must manually create two clients, then edit one to add spouse_id. This plan provides a single-click workflow that creates both spouses, links them, and navigates to joint analysis.

Output: Working "Create Married Couple" button, two-column modal form, backend endpoint, and redirect to joint analysis.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-strategies-workflow/04-RESEARCH.md

# Key existing patterns
# routes/clients.py - existing client CRUD and link-spouse endpoint
# templates/clients.html - existing modal pattern for single client
# static/js/clients.js - existing saveClient() and modal functions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add create-couple endpoint to routes/clients.py</name>
  <files>routes/clients.py</files>
  <action>
Add POST /api/clients/create-couple endpoint that:

1. Accepts JSON payload with spouse1 and spouse2 objects:
   ```python
   @clients_bp.route('/clients/create-couple', methods=['POST'])
   def create_couple():
       data = request.get_json()
       spouse1_data = data.get('spouse1')
       spouse2_data = data.get('spouse2')
   ```

2. Validates both spouse objects have required fields (first_name, last_name, filing_status):
   - Return 400 error if either spouse data missing or incomplete
   - Validate filing_status is married_joint or married_separate

3. Creates spouse1 first, flushes to get ID:
   ```python
   spouse1 = Client(
       first_name=spouse1_data['first_name'],
       last_name=spouse1_data['last_name'],
       filing_status=spouse1_data.get('filing_status', 'married_joint'),
       email=spouse1_data.get('email'),
       phone=spouse1_data.get('phone')
   )
   db.session.add(spouse1)
   db.session.flush()  # Get spouse1.id
   ```

4. Creates spouse2 linked to spouse1:
   ```python
   spouse2 = Client(
       first_name=spouse2_data['first_name'],
       last_name=spouse2_data['last_name'],
       filing_status=spouse2_data.get('filing_status', 'married_joint'),
       email=spouse2_data.get('email'),
       phone=spouse2_data.get('phone'),
       spouse_id=spouse1.id
   )
   db.session.add(spouse2)
   db.session.flush()
   ```

5. Links spouse1 back to spouse2 (bidirectional):
   ```python
   spouse1.spouse_id = spouse2.id
   db.session.commit()
   ```

6. Returns 201 with both spouses and joint analysis URL:
   ```python
   return jsonify({
       'spouse1': spouse1.to_dict(),
       'spouse2': spouse2.to_dict(),
       'joint_analysis_url': f'/joint-analysis.html?spouse1_id={spouse1.id}&spouse2_id={spouse2.id}'
   }), 201
   ```

Follow existing endpoint patterns in the file. Add import for datetime if not present.
  </action>
  <verify>
Run: `curl -X POST http://localhost:5001/api/clients/create-couple -H "Content-Type: application/json" -d '{"spouse1":{"first_name":"John","last_name":"Doe","filing_status":"married_joint"},"spouse2":{"first_name":"Jane","last_name":"Doe","filing_status":"married_joint"}}'`

Should return 201 with both spouse objects and joint_analysis_url containing both IDs.
  </verify>
  <done>
POST /api/clients/create-couple creates two linked clients and returns joint_analysis_url.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add couple creation modal to templates/clients.html</name>
  <files>templates/clients.html</files>
  <action>
Add "Create Married Couple" button and modal form:

1. Add button next to existing "Add New Client" button:
   ```html
   <button class="btn btn-primary" onclick="showClientModal()">Add New Client</button>
   <button class="btn btn-secondary" onclick="showCoupleModal()">Create Married Couple</button>
   ```

2. Add couple modal after existing client-modal (before script tag):
   ```html
   <!-- Couple Modal -->
   <div id="couple-modal" class="modal">
       <div class="modal-content" style="max-width: 800px;">
           <span class="close" onclick="closeCoupleModal()">&times;</span>
           <h2>Create Married Couple</h2>
           <form id="couple-form" onsubmit="createCouple(event)">
               <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                   <!-- Spouse 1 Column -->
                   <div class="spouse-column">
                       <h3>Spouse 1 (Taxpayer)</h3>

                       <div class="form-group">
                           <label for="spouse1-first-name">First Name *</label>
                           <input type="text" id="spouse1-first-name" required>
                       </div>

                       <div class="form-group">
                           <label for="spouse1-last-name">Last Name *</label>
                           <input type="text" id="spouse1-last-name" required>
                       </div>

                       <div class="form-group">
                           <label for="spouse1-email">Email</label>
                           <input type="email" id="spouse1-email">
                       </div>

                       <div class="form-group">
                           <label for="spouse1-phone">Phone</label>
                           <input type="tel" id="spouse1-phone">
                       </div>
                   </div>

                   <!-- Spouse 2 Column -->
                   <div class="spouse-column">
                       <h3>Spouse 2</h3>

                       <div class="form-group">
                           <label for="spouse2-first-name">First Name *</label>
                           <input type="text" id="spouse2-first-name" required>
                       </div>

                       <div class="form-group">
                           <label for="spouse2-last-name">Last Name *</label>
                           <input type="text" id="spouse2-last-name" required>
                       </div>

                       <div class="form-group">
                           <label for="spouse2-email">Email</label>
                           <input type="email" id="spouse2-email">
                       </div>

                       <div class="form-group">
                           <label for="spouse2-phone">Phone</label>
                           <input type="tel" id="spouse2-phone">
                       </div>
                   </div>
               </div>

               <!-- Shared Filing Status -->
               <div class="form-group" style="margin-top: 1.5rem;">
                   <label for="couple-filing-status">Filing Status *</label>
                   <select id="couple-filing-status" required>
                       <option value="married_joint" selected>Married Filing Jointly</option>
                       <option value="married_separate">Married Filing Separately</option>
                   </select>
               </div>

               <div class="form-actions">
                   <button type="button" class="btn btn-secondary" onclick="closeCoupleModal()">Cancel</button>
                   <button type="submit" class="btn btn-primary">Create Couple & View Analysis</button>
               </div>
           </form>
       </div>
   </div>
   ```

The modal uses existing CSS classes (modal, modal-content, form-group, btn) for consistency.
  </action>
  <verify>
Open http://localhost:5001/clients.html in browser. Verify:
1. "Create Married Couple" button appears next to "Add New Client"
2. Clicking button shows modal with two-column form layout
  </verify>
  <done>
Couple modal with two-column layout renders on clients page.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add JavaScript handlers for couple creation</name>
  <files>static/js/clients.js</files>
  <action>
Add modal handlers and API call function to static/js/clients.js:

1. Add showCoupleModal() function:
   ```javascript
   function showCoupleModal() {
       document.getElementById('couple-modal').style.display = 'block';
       // Reset form
       document.getElementById('couple-form').reset();
   }
   ```

2. Add closeCoupleModal() function:
   ```javascript
   function closeCoupleModal() {
       document.getElementById('couple-modal').style.display = 'none';
   }
   ```

3. Add createCouple(event) function:
   ```javascript
   async function createCouple(event) {
       event.preventDefault();

       const filingStatus = document.getElementById('couple-filing-status').value;

       const coupleData = {
           spouse1: {
               first_name: document.getElementById('spouse1-first-name').value,
               last_name: document.getElementById('spouse1-last-name').value,
               email: document.getElementById('spouse1-email').value || null,
               phone: document.getElementById('spouse1-phone').value || null,
               filing_status: filingStatus
           },
           spouse2: {
               first_name: document.getElementById('spouse2-first-name').value,
               last_name: document.getElementById('spouse2-last-name').value,
               email: document.getElementById('spouse2-email').value || null,
               phone: document.getElementById('spouse2-phone').value || null,
               filing_status: filingStatus
           }
       };

       try {
           const response = await fetch('/api/clients/create-couple', {
               method: 'POST',
               headers: {
                   'Content-Type': 'application/json'
               },
               body: JSON.stringify(coupleData)
           });

           if (!response.ok) {
               const errorData = await response.json();
               throw new Error(errorData.error || 'Failed to create couple');
           }

           const result = await response.json();

           // Redirect to joint analysis page
           window.location.href = result.joint_analysis_url;

       } catch (error) {
           console.error('Error creating couple:', error);
           alert('Error creating couple: ' + error.message);
       }
   }
   ```

4. Add click-outside-to-close handler for couple modal (in DOMContentLoaded or at bottom):
   ```javascript
   // Close couple modal when clicking outside
   window.onclick = function(event) {
       const clientModal = document.getElementById('client-modal');
       const coupleModal = document.getElementById('couple-modal');
       if (event.target === clientModal) {
           closeClientModal();
       }
       if (event.target === coupleModal) {
           closeCoupleModal();
       }
   };
   ```
   Note: If window.onclick already exists, extend it to handle both modals.
  </action>
  <verify>
In browser at http://localhost:5001/clients.html:
1. Click "Create Married Couple" button
2. Fill in both spouse names (required fields)
3. Select filing status
4. Click "Create Couple & View Analysis"
5. Verify redirect to joint-analysis.html with spouse IDs in URL parameters
6. Verify both spouses appear in joint analysis dropdowns
  </verify>
  <done>
Complete workflow: button click -> modal -> form submit -> API call -> redirect to joint analysis with spouses pre-selected.
  </done>
</task>

</tasks>

<verification>
1. Endpoint verification: `curl -X POST http://localhost:5001/api/clients/create-couple -H "Content-Type: application/json" -d '{"spouse1":{"first_name":"Test1","last_name":"User","filing_status":"married_joint"},"spouse2":{"first_name":"Test2","last_name":"User","filing_status":"married_joint"}}'` returns 201 with joint_analysis_url

2. UI verification: Navigate to /clients.html, click "Create Married Couple", fill form, submit, verify redirect to /joint-analysis.html with spouse IDs

3. Linkage verification: Both created clients have spouse_id pointing to each other
</verification>

<success_criteria>
- POST /api/clients/create-couple creates two clients with bidirectional spouse_id links
- "Create Married Couple" button visible on clients page
- Two-column modal form accepts both spouse details
- Form submission creates clients and redirects to joint analysis with spouses pre-selected
- Entire flow works without page refresh (except final redirect)
</success_criteria>

<output>
After completion, create `.planning/phases/04-strategies-workflow/04-01-SUMMARY.md`
</output>
