---
phase: 04-strategies-workflow
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - models/document.py
  - routes/documents.py
  - templates/upload.html
  - static/js/upload.js
autonomous: true

must_haves:
  truths:
    - "User uploading document for client with spouse sees attribution selector"
    - "User can tag document as Taxpayer, Spouse, or Joint"
    - "Document with 'spouse' attribution routes extracted data to spouse's client record"
    - "User can manually enter income data without uploading a document"
    - "Manual entry creates ExtractedData records for analysis"
  artifacts:
    - path: "models/document.py"
      provides: "Document.attribution column"
      contains: "attribution"
    - path: "routes/documents.py"
      provides: "Attribution handling in upload, manual entry endpoint"
      contains: "attribution"
    - path: "templates/upload.html"
      provides: "Attribution selector and manual entry form"
      contains: "attribution-selector"
    - path: "static/js/upload.js"
      provides: "Attribution logic and manual entry handlers"
      contains: "attribution"
  key_links:
    - from: "static/js/upload.js"
      to: "/api/documents/upload"
      via: "form data includes attribution field"
      pattern: "formData.append.*attribution"
    - from: "routes/documents.py"
      to: "client.spouse_id"
      via: "route to spouse when attribution='spouse'"
      pattern: "if attribution.*spouse.*spouse_id"
---

<objective>
Add document attribution for dual-filer uploads and manual income entry support.

Purpose: Tax professionals need to indicate which spouse a document belongs to (W-2 for husband vs W-2 for wife), and need alternative data entry when documents are unavailable.

Output: Attribution selector on upload page, backend routing logic, and manual income entry form.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-strategies-workflow/04-RESEARCH.md
@.planning/phases/04-strategies-workflow/04-01-SUMMARY.md

# Key patterns from existing code
# models/document.py - Document model structure
# routes/documents.py - upload endpoint, process endpoint
# templates/upload.html - existing upload UI with client selector
# static/js/upload.js - file upload handlers
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add attribution column to Document model</name>
  <files>models/document.py</files>
  <action>
Modify models/document.py to add attribution column:

1. Add attribution column after ocr_status:
   ```python
   attribution = db.Column(db.Text, default='taxpayer', nullable=False)  # 'taxpayer', 'spouse', 'joint'
   ```

2. Update to_dict() to include attribution:
   ```python
   def to_dict(self):
       return {
           'id': self.id,
           'client_id': self.client_id,
           'filename': self.filename,
           'file_path': self.file_path,
           'file_type': self.file_type,
           'tax_year': self.tax_year,
           'uploaded_at': self.uploaded_at.isoformat() if self.uploaded_at else None,
           'ocr_status': self.ocr_status,
           'attribution': self.attribution
       }
   ```

Note: SQLite will need the column added. The schema change will be applied when the app runs (db.create_all() creates missing columns for existing tables in SQLAlchemy with SQLite).
  </action>
  <verify>
Run Python to verify model change:
```python
from models import Document
doc = Document(client_id=1, filename='test.pdf', file_path='/tmp/test.pdf', file_type='pdf', attribution='spouse')
print(doc.attribution)  # Should print 'spouse'
```
  </verify>
  <done>
Document model has attribution column with default 'taxpayer'.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add attribution handling and manual entry endpoint to routes/documents.py</name>
  <files>routes/documents.py</files>
  <action>
Modify routes/documents.py:

1. Update upload_document() to handle attribution:
   ```python
   @documents_bp.route('/documents/upload', methods=['POST'])
   def upload_document():
       """Upload a tax document with optional attribution"""
       if 'file' not in request.files:
           return jsonify({'error': 'No file provided'}), 400

       file = request.files['file']
       client_id = request.form.get('client_id', type=int)
       tax_year = request.form.get('tax_year', type=int)
       attribution = request.form.get('attribution', 'taxpayer')  # NEW

       if not client_id:
           return jsonify({'error': 'Missing client_id'}), 400

       # Validate attribution value
       if attribution not in ['taxpayer', 'spouse', 'joint']:
           return jsonify({'error': 'Invalid attribution. Must be taxpayer, spouse, or joint'}), 400

       # If attribution is 'spouse', validate client has spouse_id
       if attribution == 'spouse':
           client = Client.query.get(client_id)
           if not client or not client.spouse_id:
               return jsonify({'error': 'Cannot use spouse attribution - no spouse linked'}), 400

       # ... rest of existing validation ...

       # Create document record with attribution
       document = Document(
           client_id=client_id,
           filename=filename,
           file_path=file_path,
           file_type=file_type,
           tax_year=tax_year,
           attribution=attribution,  # NEW
           ocr_status='pending'
       )
       # ... rest of function unchanged ...
   ```

2. Add Client import at top if not present:
   ```python
   from models import db, Document, Client, ExtractedData
   ```

3. Add manual entry endpoint:
   ```python
   @documents_bp.route('/documents/manual-entry', methods=['POST'])
   def manual_entry():
       """Create extracted data from manual income entry"""
       data = request.get_json()

       client_id = data.get('client_id')
       tax_year = data.get('tax_year', 2026)
       attribution = data.get('attribution', 'taxpayer')
       income_data = data.get('income_data', {})

       if not client_id:
           return jsonify({'error': 'Missing client_id'}), 400

       # Determine target client based on attribution
       target_client_id = client_id
       if attribution == 'spouse':
           client = Client.query.get(client_id)
           if not client or not client.spouse_id:
               return jsonify({'error': 'Cannot use spouse attribution - no spouse linked'}), 400
           target_client_id = client.spouse_id

       # Create ExtractedData records for each income field
       created_records = []

       # W-2 wages
       if income_data.get('wages'):
           record = ExtractedData(
               document_id=None,  # No document for manual entry
               client_id=target_client_id,
               form_type='W-2',
               field_name='wages',
               field_value=str(income_data['wages']),
               tax_year=tax_year
           )
           db.session.add(record)
           created_records.append({'form': 'W-2', 'field': 'wages', 'value': income_data['wages']})

       if income_data.get('federal_withheld'):
           record = ExtractedData(
               document_id=None,
               client_id=target_client_id,
               form_type='W-2',
               field_name='federal_tax_withheld',
               field_value=str(income_data['federal_withheld']),
               tax_year=tax_year
           )
           db.session.add(record)
           created_records.append({'form': 'W-2', 'field': 'federal_tax_withheld', 'value': income_data['federal_withheld']})

       # Schedule C (self-employment)
       if income_data.get('schedule_c_income'):
           record = ExtractedData(
               document_id=None,
               client_id=target_client_id,
               form_type='Schedule C',
               field_name='net_profit',
               field_value=str(income_data['schedule_c_income']),
               tax_year=tax_year
           )
           db.session.add(record)
           created_records.append({'form': 'Schedule C', 'field': 'net_profit', 'value': income_data['schedule_c_income']})

       # Interest income
       if income_data.get('interest_income'):
           record = ExtractedData(
               document_id=None,
               client_id=target_client_id,
               form_type='1099-INT',
               field_name='interest',
               field_value=str(income_data['interest_income']),
               tax_year=tax_year
           )
           db.session.add(record)
           created_records.append({'form': '1099-INT', 'field': 'interest', 'value': income_data['interest_income']})

       # Dividend income
       if income_data.get('dividend_income'):
           record = ExtractedData(
               document_id=None,
               client_id=target_client_id,
               form_type='1099-DIV',
               field_name='dividends',
               field_value=str(income_data['dividend_income']),
               tax_year=tax_year
           )
           db.session.add(record)
           created_records.append({'form': '1099-DIV', 'field': 'dividends', 'value': income_data['dividend_income']})

       db.session.commit()

       # Trigger analysis for the target client
       analysis_triggered = False
       try:
           from services.analysis_engine import AnalysisEngine
           AnalysisEngine.analyze_client(target_client_id)
           analysis_triggered = True
       except Exception as e:
           current_app.logger.error(f'Analysis failed after manual entry: {str(e)}')

       return jsonify({
           'message': 'Manual entry saved successfully',
           'client_id': target_client_id,
           'records_created': created_records,
           'analysis_triggered': analysis_triggered
       }), 201
   ```

4. If ExtractedData is not imported, add it:
   ```python
   from models import db, Document, Client, ExtractedData
   ```
  </action>
  <verify>
Test attribution validation:
```bash
curl -X POST http://localhost:5001/api/documents/manual-entry \
  -H "Content-Type: application/json" \
  -d '{"client_id":1,"tax_year":2026,"attribution":"taxpayer","income_data":{"wages":50000}}'
```
Should return 201 with records_created array.
  </verify>
  <done>
Upload endpoint accepts attribution parameter, manual entry endpoint creates ExtractedData records.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add attribution selector and manual entry UI to upload page</name>
  <files>templates/upload.html, static/js/upload.js</files>
  <action>
**Part A: Modify templates/upload.html**

1. Add attribution selector after tax-year input (inside upload-section div):
   ```html
   <div class="form-group" id="attribution-group" style="display: none;">
       <label for="attribution-select">Document belongs to:</label>
       <select id="attribution-select">
           <option value="taxpayer">Taxpayer (Primary Client)</option>
           <option value="spouse">Spouse</option>
           <option value="joint">Joint (Both)</option>
       </select>
       <small class="help-text">Select which spouse this document is for</small>
   </div>
   ```

2. Add tabs for Document Upload vs Manual Entry before upload-area:
   ```html
   <div class="data-entry-tabs">
       <button class="tab-btn active" onclick="showUploadTab()">Document Upload</button>
       <button class="tab-btn" onclick="showManualTab()">Manual Entry</button>
   </div>
   ```

3. Wrap existing upload-area in a tab container:
   ```html
   <div id="upload-tab" class="tab-content active">
       <!-- Move existing upload-area, file-list, upload-actions here -->
       <div class="upload-area" id="upload-area">
           ...existing content...
       </div>
       <div id="file-list" class="file-list"></div>
       <div class="upload-actions">
           <button class="btn btn-primary" id="upload-btn" onclick="uploadFiles()" disabled>Upload Files</button>
           <button class="btn btn-secondary" onclick="clearFiles()">Clear</button>
       </div>
   </div>
   ```

4. Add manual entry tab content after upload-tab:
   ```html
   <div id="manual-tab" class="tab-content" style="display: none;">
       <h4>Enter Income Data Manually</h4>

       <div class="manual-entry-form">
           <div class="form-section">
               <h5>W-2 Income</h5>
               <div class="form-group">
                   <label for="manual-wages">Wages (Box 1)</label>
                   <input type="number" id="manual-wages" placeholder="0.00" step="0.01">
               </div>
               <div class="form-group">
                   <label for="manual-federal-withheld">Federal Tax Withheld (Box 2)</label>
                   <input type="number" id="manual-federal-withheld" placeholder="0.00" step="0.01">
               </div>
           </div>

           <div class="form-section">
               <h5>Self-Employment Income</h5>
               <div class="form-group">
                   <label for="manual-schedule-c">Net Profit (Schedule C Line 31)</label>
                   <input type="number" id="manual-schedule-c" placeholder="0.00" step="0.01">
               </div>
           </div>

           <div class="form-section">
               <h5>Other Income</h5>
               <div class="form-group">
                   <label for="manual-interest">Interest Income</label>
                   <input type="number" id="manual-interest" placeholder="0.00" step="0.01">
               </div>
               <div class="form-group">
                   <label for="manual-dividends">Dividend Income</label>
                   <input type="number" id="manual-dividends" placeholder="0.00" step="0.01">
               </div>
           </div>

           <div class="form-actions">
               <button class="btn btn-primary" onclick="saveManualEntry()">Save Income Data</button>
               <button class="btn btn-secondary" onclick="clearManualEntry()">Clear</button>
           </div>
       </div>
   </div>
   ```

5. Add CSS for tabs (inline style block or add to style.css reference):
   ```html
   <style>
   .data-entry-tabs {
       display: flex;
       gap: 0;
       margin-bottom: 1rem;
   }
   .tab-btn {
       padding: 0.75rem 1.5rem;
       border: 1px solid #ddd;
       background: #f5f5f5;
       cursor: pointer;
       border-radius: 4px 4px 0 0;
       margin-right: -1px;
   }
   .tab-btn.active {
       background: white;
       border-bottom-color: white;
       font-weight: bold;
   }
   .tab-content {
       border: 1px solid #ddd;
       padding: 1.5rem;
       border-radius: 0 4px 4px 4px;
   }
   .form-section {
       margin-bottom: 1.5rem;
       padding-bottom: 1rem;
       border-bottom: 1px solid #eee;
   }
   .form-section h5 {
       margin-bottom: 0.75rem;
       color: #555;
   }
   .manual-entry-form input[type="number"] {
       width: 100%;
       max-width: 200px;
   }
   .help-text {
       color: #666;
       font-size: 0.85rem;
   }
   </style>
   ```

**Part B: Modify static/js/upload.js**

1. Add function to check if client has spouse and show/hide attribution:
   ```javascript
   async function checkClientHasSpouse() {
       const clientId = document.getElementById('client-select').value;
       const attributionGroup = document.getElementById('attribution-group');

       if (!clientId) {
           attributionGroup.style.display = 'none';
           return;
       }

       try {
           const response = await fetch(`/api/clients/${clientId}`);
           if (response.ok) {
               const client = await response.json();
               if (client.spouse_id) {
                   attributionGroup.style.display = 'block';
               } else {
                   attributionGroup.style.display = 'none';
               }
           }
       } catch (error) {
           console.error('Error checking spouse:', error);
           attributionGroup.style.display = 'none';
       }
   }
   ```

2. Add event listener for client-select change (in DOMContentLoaded or initialization):
   ```javascript
   document.getElementById('client-select').addEventListener('change', checkClientHasSpouse);
   ```

3. Update uploadFiles() function to include attribution in FormData:
   Find the FormData append section and add:
   ```javascript
   const attribution = document.getElementById('attribution-select').value;
   formData.append('attribution', attribution);
   ```

4. Add tab switching functions:
   ```javascript
   function showUploadTab() {
       document.getElementById('upload-tab').style.display = 'block';
       document.getElementById('manual-tab').style.display = 'none';
       document.querySelectorAll('.tab-btn')[0].classList.add('active');
       document.querySelectorAll('.tab-btn')[1].classList.remove('active');
   }

   function showManualTab() {
       document.getElementById('upload-tab').style.display = 'none';
       document.getElementById('manual-tab').style.display = 'block';
       document.querySelectorAll('.tab-btn')[0].classList.remove('active');
       document.querySelectorAll('.tab-btn')[1].classList.add('active');
   }
   ```

5. Add manual entry save function:
   ```javascript
   async function saveManualEntry() {
       const clientId = document.getElementById('client-select').value;
       const taxYear = document.getElementById('tax-year').value || 2026;
       const attribution = document.getElementById('attribution-select').value;

       if (!clientId) {
           alert('Please select a client first');
           return;
       }

       const incomeData = {
           wages: parseFloat(document.getElementById('manual-wages').value) || null,
           federal_withheld: parseFloat(document.getElementById('manual-federal-withheld').value) || null,
           schedule_c_income: parseFloat(document.getElementById('manual-schedule-c').value) || null,
           interest_income: parseFloat(document.getElementById('manual-interest').value) || null,
           dividend_income: parseFloat(document.getElementById('manual-dividends').value) || null
       };

       // Check if any data was entered
       const hasData = Object.values(incomeData).some(v => v !== null && v > 0);
       if (!hasData) {
           alert('Please enter at least one income value');
           return;
       }

       try {
           const response = await fetch('/api/documents/manual-entry', {
               method: 'POST',
               headers: {
                   'Content-Type': 'application/json'
               },
               body: JSON.stringify({
                   client_id: parseInt(clientId),
                   tax_year: parseInt(taxYear),
                   attribution: attribution,
                   income_data: incomeData
               })
           });

           if (!response.ok) {
               const errorData = await response.json();
               throw new Error(errorData.error || 'Failed to save manual entry');
           }

           const result = await response.json();
           alert(`Income data saved successfully! ${result.records_created.length} records created.`);
           clearManualEntry();

       } catch (error) {
           console.error('Error saving manual entry:', error);
           alert('Error: ' + error.message);
       }
   }

   function clearManualEntry() {
       document.getElementById('manual-wages').value = '';
       document.getElementById('manual-federal-withheld').value = '';
       document.getElementById('manual-schedule-c').value = '';
       document.getElementById('manual-interest').value = '';
       document.getElementById('manual-dividends').value = '';
   }
   ```
  </action>
  <verify>
1. Navigate to http://localhost:5001/upload.html
2. Select a client that has a spouse linked - attribution selector should appear
3. Select a client without spouse - attribution selector should be hidden
4. Click "Manual Entry" tab - form should display
5. Enter wages amount, click Save - should succeed
6. Verify ExtractedData record created for client
  </verify>
  <done>
Upload page has attribution selector (shown only for clients with spouses) and manual entry form.
  </done>
</task>

</tasks>

<verification>
1. Document model: `from models import Document; d = Document(); print(hasattr(d, 'attribution'))` returns True

2. Attribution routing: Upload document with attribution='spouse' for client with spouse_id - verify document.client_id matches the SELECTED client (not spouse) but extracted data routes correctly

3. Manual entry: POST to /api/documents/manual-entry with wages data - verify ExtractedData record created

4. UI attribution: Select client with spouse, verify attribution dropdown appears; select client without spouse, verify hidden

5. UI manual entry: Fill manual form, save, verify success message and records created
</verification>

<success_criteria>
- Document model has attribution column (taxpayer/spouse/joint)
- Upload endpoint accepts and stores attribution parameter
- Attribution selector appears only when client has spouse_id
- Manual entry endpoint creates ExtractedData records
- Manual entry form collects W-2, Schedule C, and other income types
- Both document upload and manual entry trigger analysis after save
</success_criteria>

<output>
After completion, create `.planning/phases/04-strategies-workflow/04-02-SUMMARY.md`
</output>
