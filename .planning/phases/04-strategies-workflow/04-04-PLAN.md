---
phase: 04-strategies-workflow
plan: 04
type: execute
wave: 3
depends_on: ["04-03"]
files_modified:
  - services/joint_strategy_service.py
  - services/joint_analysis_service.py
  - static/js/joint_analysis.js
  - static/css/style.css
autonomous: true

must_haves:
  truths:
    - "MFJ analysis shows joint-only strategies like Spousal IRA and Bracket Utilization"
    - "Joint strategies section appears in comparison area (not individual panels)"
    - "Strategies show warning badge when viewing MFS: 'Requires MFJ filing status'"
    - "MFS-ineligible strategies (EITC, education credits) show feasibility warning"
  artifacts:
    - path: "services/joint_strategy_service.py"
      provides: "JointStrategyService generating MFJ-only strategies"
      contains: "spousal_ira"
    - path: "services/joint_analysis_service.py"
      provides: "Integration of joint strategies in analyze_joint response"
      contains: "joint_strategies"
    - path: "static/js/joint_analysis.js"
      provides: "Joint strategies display and feasibility warnings"
      contains: "renderJointStrategies"
  key_links:
    - from: "services/joint_strategy_service.py"
      to: "spouse summaries"
      via: "generate_joint_strategies takes spouse1_summary, spouse2_summary"
      pattern: "generate_joint_strategies.*spouse1_summary.*spouse2_summary"
    - from: "static/js/joint_analysis.js"
      to: "API joint_strategies"
      via: "display joint strategies in comparison section"
      pattern: "result\\.joint_strategies"
---

<objective>
Add joint-only optimization strategies and feasibility warnings for filing status restrictions.

Purpose: When filing jointly, couples have access to strategies unavailable for MFS (Spousal IRA, EITC, education credits). This plan generates these recommendations and shows clear warnings when strategies require MFJ.

Output: JointStrategyService, joint strategies in comparison section, and feasibility warning badges.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-strategies-workflow/04-RESEARCH.md
@.planning/phases/04-strategies-workflow/04-03-SUMMARY.md

# Key existing patterns
# services/joint_analysis_service.py - analyze_joint returns comparison data
# static/js/joint_analysis.js - displayComparison renders comparison section
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create JointStrategyService for MFJ-only strategies</name>
  <files>services/joint_strategy_service.py</files>
  <action>
Create new file services/joint_strategy_service.py:

```python
"""
Joint Strategy Service - MFJ-Only Optimization Strategies

Generates strategies that are only available when filing jointly:
- Spousal IRA (non-working spouse can contribute using working spouse's income)
- Bracket Utilization (wider MFJ brackets save money vs 2x MFS brackets)
- EITC Eligibility (MFS filers are generally ineligible)
- Education Credits (AOTC, LLC unavailable for MFS)

These strategies are NOT personalized to income type - they're joint optimizations.
"""


class JointStrategyService:
    """Service for generating joint-only optimization strategies"""

    # 2026 IRA limits
    IRA_LIMIT_2026 = 7500
    IRA_CATCHUP_2026 = 1000  # Additional for 50+

    # Strategy definitions
    JOINT_STRATEGIES = [
        {
            'id': 'spousal_ira',
            'name': 'Spousal IRA Contribution',
            'requires': 'married_joint',
            'description': 'Non-working spouse can contribute to IRA using working spouse earned income',
            'check_method': '_check_spousal_ira'
        },
        {
            'id': 'bracket_utilization',
            'name': 'MFJ Bracket Utilization',
            'requires': 'married_joint',
            'description': 'MFJ brackets are wider, keeping more income in lower tiers',
            'check_method': '_check_bracket_benefit'
        },
        {
            'id': 'eitc_eligibility',
            'name': 'Earned Income Tax Credit (EITC)',
            'requires': 'married_joint',
            'description': 'Up to $8,046 credit for qualifying families',
            'check_method': '_check_eitc'
        },
        {
            'id': 'education_credits',
            'name': 'Education Credits (AOTC/LLC)',
            'requires': 'married_joint',
            'description': 'American Opportunity ($2,500) and Lifetime Learning ($2,000) credits',
            'check_method': '_check_education_credits'
        }
    ]

    # Filing status requirements for all strategies (including individual ones)
    STRATEGY_FILING_REQUIREMENTS = {
        'spousal_ira': {'requires': 'married_joint', 'warning': 'Spousal IRA requires filing jointly'},
        'eitc_eligibility': {'requires': 'married_joint', 'warning': 'EITC unavailable when filing separately'},
        'education_credits': {'requires': 'married_joint', 'warning': 'Education credits unavailable when filing separately'},
        'student_loan_interest': {'requires': 'married_joint', 'warning': 'Student loan interest deduction unavailable when filing separately'},
        'adoption_credit': {'requires': 'married_joint', 'warning': 'Adoption credit unavailable when filing separately'},
        'roth_ira_direct': {'mfs_limit': 10000, 'warning': 'Roth IRA MAGI limit is $10,000 for MFS (vs $230,000 MFJ)'},
        # Most strategies have no filing status restriction
        'qbi_deduction': {'requires': None, 'note': 'Available for both MFJ and MFS, but thresholds differ'},
        'retirement_contributions': {'requires': None, 'note': 'Available for both filing statuses'},
        'section_179': {'requires': None, 'note': 'Available for both filing statuses'},
        'bonus_depreciation': {'requires': None, 'note': 'Available for both filing statuses'},
        'home_office': {'requires': None, 'note': 'Available for both filing statuses'},
        'se_tax_deduction': {'requires': None, 'note': 'Available for both filing statuses'},
        'se_health_insurance': {'requires': None, 'note': 'Available for both filing statuses'},
    }

    @staticmethod
    def generate_joint_strategies(spouse1_summary, spouse2_summary, mfj_result, mfs_result):
        """
        Generate strategies available only when filing jointly.

        Args:
            spouse1_summary: Analysis summary for spouse 1
            spouse2_summary: Analysis summary for spouse 2
            mfj_result: MFJ calculation result dict
            mfs_result: MFS calculation result dict (combined both spouses)

        Returns:
            list: Joint strategy recommendations
        """
        strategies = []

        for strategy_def in JointStrategyService.JOINT_STRATEGIES:
            check_method = getattr(JointStrategyService, strategy_def['check_method'])
            result = check_method(spouse1_summary, spouse2_summary, mfj_result, mfs_result)

            if result['applicable']:
                strategies.append({
                    'strategy_id': strategy_def['id'],
                    'strategy_name': strategy_def['name'],
                    'requires_filing_status': strategy_def['requires'],
                    'description': strategy_def['description'],
                    'status': result['status'],
                    'potential_benefit': result.get('benefit', 0),
                    'recommendation': result.get('recommendation', ''),
                    'details': result.get('details', {}),
                    'warning_if_mfs': f"Not available with MFS: {strategy_def['name']}"
                })

        return strategies

    @staticmethod
    def get_filing_requirement(strategy_id):
        """
        Get filing status requirement for a strategy.

        Args:
            strategy_id: Strategy identifier

        Returns:
            dict: {requires, warning} or None if no requirement
        """
        return JointStrategyService.STRATEGY_FILING_REQUIREMENTS.get(strategy_id)

    @staticmethod
    def _check_spousal_ira(spouse1_summary, spouse2_summary, mfj_result, mfs_result):
        """Check Spousal IRA eligibility and benefit"""
        spouse1_income = spouse1_summary.get('total_income', 0)
        spouse2_income = spouse2_summary.get('total_income', 0)
        combined_income = spouse1_income + spouse2_income

        # Spousal IRA requires one spouse with low/no earned income
        # while the other has sufficient income to cover contributions
        limit = JointStrategyService.IRA_LIMIT_2026

        low_income_spouse = None
        if spouse1_income < limit and spouse2_income >= limit:
            low_income_spouse = 'spouse1'
            working_spouse_income = spouse2_income
        elif spouse2_income < limit and spouse1_income >= limit:
            low_income_spouse = 'spouse2'
            working_spouse_income = spouse1_income
        else:
            # Both have sufficient income - no spousal IRA benefit
            return {
                'applicable': False,
                'reason': 'Both spouses have sufficient earned income for their own IRA'
            }

        # Calculate tax benefit (estimate 22% marginal rate if unknown)
        marginal_rate = mfj_result.get('marginal_rate', 22) / 100
        max_contribution = limit
        benefit = max_contribution * marginal_rate

        return {
            'applicable': True,
            'status': 'POTENTIALLY_MISSED',
            'benefit': round(benefit, 2),
            'recommendation': f"Non-working spouse ({low_income_spouse}) can contribute up to ${max_contribution:,} to IRA using working spouse's earned income",
            'details': {
                'beneficiary': low_income_spouse,
                'max_contribution': max_contribution,
                'estimated_tax_savings': round(benefit, 2),
                'working_spouse_income': working_spouse_income
            }
        }

    @staticmethod
    def _check_bracket_benefit(spouse1_summary, spouse2_summary, mfj_result, mfs_result):
        """Check MFJ bracket utilization benefit"""
        mfj_tax = mfj_result.get('total_tax', 0)
        mfs_combined_tax = mfs_result.get('mfs_combined_tax', 0) if isinstance(mfs_result, dict) else 0

        if mfs_combined_tax <= 0:
            return {'applicable': False, 'reason': 'MFS tax data not available'}

        # Calculate bracket savings
        savings = mfs_combined_tax - mfj_tax

        if savings <= 0:
            return {
                'applicable': True,
                'status': 'NOT_APPLICABLE',
                'benefit': 0,
                'recommendation': 'MFJ does not provide bracket savings in this case',
                'details': {}
            }

        mfj_effective = mfj_result.get('effective_rate', 0)
        combined_income = mfj_result.get('combined_income', 0)

        return {
            'applicable': True,
            'status': 'FULLY_UTILIZED' if savings > 0 else 'NOT_APPLICABLE',
            'benefit': round(savings, 2),
            'recommendation': f"Filing jointly saves ${savings:,.2f} through wider tax brackets (effective rate: {mfj_effective:.1f}%)",
            'details': {
                'mfj_tax': mfj_tax,
                'mfs_combined_tax': mfs_combined_tax,
                'savings': savings,
                'effective_rate_mfj': mfj_effective
            }
        }

    @staticmethod
    def _check_eitc(spouse1_summary, spouse2_summary, mfj_result, mfs_result):
        """Check EITC eligibility"""
        combined_income = mfj_result.get('combined_income', 0)

        # 2026 EITC income limits (no children) - rough check
        # MFJ with no children: ~$25,500 max
        # MFJ with 3+ children: ~$66,800 max
        eitc_max_income = 66800  # Assume children for max benefit

        if combined_income > eitc_max_income:
            return {
                'applicable': True,
                'status': 'NOT_APPLICABLE',
                'benefit': 0,
                'recommendation': f'Income (${combined_income:,.0f}) exceeds EITC limit',
                'details': {'income_limit': eitc_max_income}
            }

        # EITC is complex - just flag as potential
        return {
            'applicable': True,
            'status': 'POTENTIALLY_MISSED',
            'benefit': 0,  # Would need dependent info for accurate calc
            'recommendation': 'EITC may be available - requires qualifying children and income verification',
            'details': {
                'note': 'EITC is completely unavailable for MFS filers',
                'max_credit_2026': 8046  # With 3+ children
            }
        }

    @staticmethod
    def _check_education_credits(spouse1_summary, spouse2_summary, mfj_result, mfs_result):
        """Check education credit eligibility"""
        combined_income = mfj_result.get('combined_income', 0)

        # AOTC phase-out: $160k-$180k MFJ (2026 estimate)
        # LLC phase-out: $160k-$180k MFJ
        aotc_limit = 180000
        llc_limit = 180000

        if combined_income > aotc_limit:
            return {
                'applicable': True,
                'status': 'NOT_APPLICABLE',
                'benefit': 0,
                'recommendation': f'Income exceeds education credit limits',
                'details': {}
            }

        return {
            'applicable': True,
            'status': 'POTENTIALLY_MISSED',
            'benefit': 0,  # Would need education expenses for calc
            'recommendation': 'Education credits may be available if paying qualified education expenses. AOTC up to $2,500, LLC up to $2,000.',
            'details': {
                'note': 'Education credits are completely unavailable for MFS filers',
                'aotc_max': 2500,
                'llc_max': 2000
            }
        }
```
  </action>
  <verify>
Test the service:
```python
from services.joint_strategy_service import JointStrategyService

# Mock data
spouse1 = {'total_income': 250000}
spouse2 = {'total_income': 5000}  # Low income spouse
mfj = {'total_tax': 50000, 'combined_income': 255000, 'effective_rate': 19.6, 'marginal_rate': 24}
mfs = {'mfs_combined_tax': 55000}

strategies = JointStrategyService.generate_joint_strategies(spouse1, spouse2, mfj, mfs)
print([s['strategy_name'] for s in strategies])
# Should include 'Spousal IRA Contribution'
```
  </verify>
  <done>
JointStrategyService generates Spousal IRA, Bracket Utilization, EITC, and Education Credit recommendations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate joint strategies into JointAnalysisService response</name>
  <files>services/joint_analysis_service.py</files>
  <action>
Modify services/joint_analysis_service.py to include joint strategies in response:

1. Add import at top of file:
   ```python
   from services.joint_strategy_service import JointStrategyService
   ```

2. In analyze_joint() method, after building comparison dict (around line 604), generate joint strategies:
   ```python
   # Step 7b: Generate joint-only strategies (REQ-22)
   mfs_combined_for_strategies = {
       'mfs_combined_tax': mfs_combined_tax,
       'mfs_spouse1_tax': mfs_spouse1_result['total_tax'],
       'mfs_spouse2_tax': mfs_spouse2_result['total_tax']
   }

   joint_strategies = JointStrategyService.generate_joint_strategies(
       spouse1_summary=spouse1_summary,
       spouse2_summary=spouse2_summary,
       mfj_result=mfj_result,
       mfs_result=mfs_combined_for_strategies
   )
   ```

3. Update the return dict (around line 663) to include joint_strategies:
   ```python
   return {
       'spouse1': {
           'summary': spouse1_summary,
           'strategies': [s.to_dict() for s in spouse1_strategies],
           'income_types': spouse1_income_types
       },
       'spouse2': {
           'summary': spouse2_summary,
           'strategies': [s.to_dict() for s in spouse2_strategies],
           'income_types': spouse2_income_types
       },
       'mfj': mfj_result,
       'mfs_spouse1': mfs_spouse1_result,
       'mfs_spouse2': mfs_spouse2_result,
       'comparison': comparison,
       'joint_strategies': joint_strategies  # NEW
   }
   ```

4. Also update _format_cached_result (around line 284) to include joint_strategies:
   ```python
   # At the end of _format_cached_result, before return, add:
   mfs_combined_for_strategies = {
       'mfs_combined_tax': cached.mfs_combined_tax,
       'mfs_spouse1_tax': cached.mfs_spouse1_tax,
       'mfs_spouse2_tax': cached.mfs_spouse2_tax
   }

   joint_strategies = JointStrategyService.generate_joint_strategies(
       spouse1_summary=spouse1_summary,
       spouse2_summary=spouse2_summary,
       mfj_result={
           'total_tax': cached.mfj_total_tax,
           'combined_income': cached.mfj_combined_income,
           'effective_rate': cached.mfj_effective_rate,
           'marginal_rate': 24  # Approximate for cached results
       },
       mfs_result=mfs_combined_for_strategies
   )

   return {
       # ... existing spouse1, spouse2, mfj, mfs_spouse1, mfs_spouse2, comparison ...
       'joint_strategies': joint_strategies
   }
   ```
  </action>
  <verify>
Test API response:
```bash
curl http://localhost:5001/api/joint-analysis/1/2 | python -m json.tool | grep -A20 joint_strategies
```
Should return array of joint strategy objects.
  </verify>
  <done>
Joint analysis API includes joint_strategies array with MFJ-only recommendations.
  </done>
</task>

<task type="auto">
  <name>Task 3: Display joint strategies and feasibility warnings in UI</name>
  <files>static/js/joint_analysis.js, static/css/style.css</files>
  <action>
**Part A: Add joint strategies rendering to static/js/joint_analysis.js**

1. Add renderJointStrategies function (after displayComparison around line 418):
   ```javascript
   /**
    * Render joint-only optimization strategies.
    * @param {Array} strategies - Joint strategy objects from API
    * @param {string} recommendedStatus - 'MFJ' or 'MFS' from comparison
    * @returns {string} HTML for joint strategies section
    */
   function renderJointStrategies(strategies, recommendedStatus) {
       if (!strategies || strategies.length === 0) {
           return '';
       }

       const isMFJRecommended = recommendedStatus === 'MFJ';

       const strategiesHtml = strategies.map(strategy => {
           const statusClass = getStatusClass(strategy.status);
           const hasBenefit = strategy.potential_benefit > 0;

           // Show warning if viewing MFS but strategy requires MFJ
           const showMFSWarning = !isMFJRecommended && strategy.requires_filing_status === 'married_joint';

           return `
               <div class="joint-strategy-card ${statusClass} ${showMFSWarning ? 'mfs-warning' : ''}">
                   <div class="strategy-header">
                       <span class="strategy-name">${strategy.strategy_name}</span>
                       ${strategy.requires_filing_status === 'married_joint' ?
                           '<span class="mfj-only-badge">MFJ Only</span>' : ''}
                   </div>
                   ${showMFSWarning ?
                       `<div class="feasibility-warning">
                           <span class="warning-icon">!</span>
                           ${strategy.warning_if_mfs}
                       </div>` : ''
                   }
                   <div class="strategy-description">${strategy.description}</div>
                   ${hasBenefit ?
                       `<div class="strategy-benefit">Potential Savings: $${formatCurrency(strategy.potential_benefit)}</div>` : ''
                   }
                   ${strategy.recommendation ?
                       `<div class="strategy-recommendation">${strategy.recommendation}</div>` : ''
                   }
               </div>
           `;
       }).join('');

       return `
           <div class="joint-strategies-section">
               <h4>Joint Optimization Strategies</h4>
               <p class="section-note">These strategies are ${isMFJRecommended ? 'available' : 'only available'} when filing jointly (MFJ)</p>
               <div class="joint-strategies-grid">
                   ${strategiesHtml}
               </div>
           </div>
       `;
   }
   ```

2. Update displayComparison to include joint strategies (modify around line 344):
   In the displayComparison function, after building comparisonDiv.innerHTML, add:
   ```javascript
   // After existing comparison content, add joint strategies
   const jointStrategiesHtml = renderJointStrategies(jointStrategies, recommendedStatus);
   ```

   Then update the loadJointAnalysis function to pass joint_strategies to displayComparison:
   Find where displayComparison is called (around line 215):
   ```javascript
   // Update the call to pass joint_strategies
   displayComparison(
       result.mfj,
       result.mfs_spouse1,
       result.mfs_spouse2,
       result.comparison,
       result.joint_strategies  // NEW parameter
   );
   ```

3. Update displayComparison function signature and add joint strategies:
   ```javascript
   function displayComparison(mfj, mfs1, mfs2, comparison, jointStrategies) {
       // ... existing code through the comparison-table ...

       // After the table, add joint strategies
       const jointStrategiesHtml = renderJointStrategies(jointStrategies || [], comparison.recommended_status);

       comparisonDiv.innerHTML = `
           <!-- existing comparison cards -->
           ...

           ${notesHtml}

           ${jointStrategiesHtml}

           <!-- REQ-20: Four-column line-by-line breakdown -->
           <h4>Filing Status Comparison Report</h4>
           <table class="comparison-table">
               ...
           </table>
       `;
   }
   ```

4. Add strategy feasibility check for individual strategies. Add to helper functions:
   ```javascript
   /**
    * Strategy filing requirements for feasibility warnings
    */
   const STRATEGY_FILING_REQUIREMENTS = {
       'spousal_ira': { requires: 'married_joint', warning: 'Spousal IRA requires filing jointly' },
       'eitc_eligibility': { requires: 'married_joint', warning: 'EITC unavailable when filing separately' },
       'education_credits': { requires: 'married_joint', warning: 'Education credits unavailable when filing separately' },
       'student_loan_interest': { requires: 'married_joint', warning: 'Student loan interest deduction unavailable when filing separately' }
   };

   /**
    * Check if strategy has filing status warning for current analysis
    */
   function getStrategyFeasibilityWarning(strategyId, currentFilingContext) {
       const req = STRATEGY_FILING_REQUIREMENTS[strategyId];
       if (req && req.requires && currentFilingContext !== req.requires) {
           return req.warning;
       }
       return null;
   }
   ```

**Part B: Add CSS for joint strategies to static/css/style.css**

Add the following styles:
```css
/* Joint Strategies Section */
.joint-strategies-section {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 2px solid #e0e0e0;
}

.joint-strategies-section h4 {
    margin-bottom: 0.5rem;
}

.section-note {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.joint-strategies-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
}

.joint-strategy-card {
    padding: 1rem;
    border-radius: 6px;
    background: #f9f9f9;
    border: 1px solid #e0e0e0;
    border-left: 4px solid #2196f3;
}

.joint-strategy-card.mfs-warning {
    background: #fff8e1;
    border-left-color: #ff9800;
}

.joint-strategy-card.status-good {
    border-left-color: #4caf50;
}

.joint-strategy-card.status-warning {
    border-left-color: #f44336;
}

.joint-strategy-card .strategy-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.joint-strategy-card .strategy-name {
    font-weight: 600;
    font-size: 1rem;
}

.mfj-only-badge {
    font-size: 0.7rem;
    padding: 2px 6px;
    background: #2196f3;
    color: white;
    border-radius: 3px;
    white-space: nowrap;
}

.feasibility-warning {
    background: #ffecb3;
    padding: 0.5rem;
    border-radius: 4px;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.warning-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    background: #ff9800;
    color: white;
    border-radius: 50%;
    font-weight: bold;
    font-size: 0.8rem;
}

.strategy-description {
    color: #555;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}

.strategy-benefit {
    font-weight: 500;
    color: #4caf50;
    margin-bottom: 0.25rem;
}

.strategy-recommendation {
    font-size: 0.85rem;
    color: #333;
    font-style: italic;
}
```
  </action>
  <verify>
1. Navigate to http://localhost:5001/joint-analysis.html
2. Load joint analysis for linked spouses
3. Verify "Joint Optimization Strategies" section appears in comparison area
4. If one spouse has low income, verify Spousal IRA strategy shows with benefit amount
5. If MFJ is recommended, strategies show without warning
6. Test with MFS-preferred scenario: verify strategies show orange warning badges
  </verify>
  <done>
Joint strategies display in comparison section with MFJ-only badges and feasibility warnings for MFS context.
  </done>
</task>

</tasks>

<verification>
1. JointStrategyService: Call generate_joint_strategies with mock data, verify returns strategies array

2. Spousal IRA detection: One spouse with $5k income, one with $200k -> Spousal IRA strategy appears

3. Bracket utilization: MFJ saves money vs MFS -> Bracket Utilization shows savings amount

4. API response: GET /api/joint-analysis/{id1}/{id2} includes joint_strategies array

5. UI display: Joint strategies section appears between comparison cards and detailed table

6. MFS warning: When MFS is recommended, joint strategies show orange warning with "Not available with MFS"
</verification>

<success_criteria>
- JointStrategyService generates 4 joint-only strategy types
- Joint strategies appear in API response under joint_strategies key
- UI shows "Joint Optimization Strategies" section in comparison area
- Spousal IRA shows potential tax savings when applicable
- Bracket Utilization shows MFJ savings amount
- Strategies show "MFJ Only" badge
- When viewing MFS-preferred analysis, strategies show feasibility warning
- EITC and education credits show "unavailable for MFS" warning
</success_criteria>

<output>
After completion, create `.planning/phases/04-strategies-workflow/04-04-SUMMARY.md`
</output>
