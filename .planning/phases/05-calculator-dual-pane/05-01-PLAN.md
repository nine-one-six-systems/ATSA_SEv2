---
phase: 05-calculator-dual-pane
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - routes/calculator.py
  - templates/calculator.html
  - static/css/style.css
autonomous: true

must_haves:
  truths:
    - "POST /api/calculator/calculate-dual accepts husband and wife data, returns MFJ and MFS results with comparison"
    - "MFJ calculation combines both spouses' incomes into single AGI with ONE standard deduction ($32,200)"
    - "FICA/SE taxes are calculated per-individual, never combined, even for MFJ"
    - "MFS calculates each spouse independently with married_separate filing status"
    - "Comparison recommends MFJ or MFS based on lower total tax"
    - "calculator.html has dual-pane HTML structure with husband/wife panes hidden by default"
    - "Single/HoH/QSS filing statuses still show single-pane form (no regression)"
    - "Split.js CDN script tag is included in calculator.html"
  artifacts:
    - path: "routes/calculator.py"
      provides: "/calculator/calculate-dual POST endpoint"
      contains: "calculate_dual_tax"
    - path: "templates/calculator.html"
      provides: "Dual-pane HTML structure with Split.js"
      contains: "dual-pane-form"
    - path: "static/css/style.css"
      provides: "Calculator dual-pane CSS styles"
      contains: "calculator-split-container"
  key_links:
    - from: "routes/calculator.py"
      to: "services/tax_calculator.py"
      via: "TaxCalculator.calculate_federal_tax(), calculate_state_tax(), calculate_fica_tax()"
      pattern: "TaxCalculator\\.calculate_federal_tax"
    - from: "templates/calculator.html"
      to: "static/js/calculator.js"
      via: "script tag at bottom of page"
      pattern: "calculator\\.js"
---

<objective>
Build the /calculate-dual backend endpoint and restructure the calculator HTML template for dual-pane mode.

Purpose: Provides the server-side MFJ/MFS orchestration logic and the HTML/CSS structure that the calculator JS will animate and wire up in Plan 05-02. The endpoint is curl-testable independently.

Output:
- New /api/calculator/calculate-dual POST endpoint in routes/calculator.py
- Restructured calculator.html with single-pane (default) and dual-pane (hidden) form sections
- CSS styles for calculator dual-pane layout
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-calculator-dual-pane/05-RESEARCH.md

# Key source files
@routes/calculator.py
@services/tax_calculator.py
@templates/calculator.html
@static/css/style.css
@templates/joint_analysis.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /calculate-dual API endpoint</name>
  <files>routes/calculator.py</files>
  <action>
Add a new route `@calculator_bp.route('/calculator/calculate-dual', methods=['POST'])` to routes/calculator.py. Do NOT modify the existing `/calculator/calculate` endpoint.

The endpoint accepts JSON:
```json
{
  "filing_status": "married_joint",
  "husband": {
    "income": 150000,
    "income_frequency": "annual",
    "income_source": "w2",
    "salary": 0,
    "distributions": 0,
    "state_code": "CA"
  },
  "wife": {
    "income": 80000,
    "income_frequency": "annual",
    "income_source": "llc",
    "salary": 0,
    "distributions": 0,
    "state_code": "NY"
  },
  "dependents": 2,
  "tax_year": 2026
}
```

Implementation requires these helper functions (add as module-level functions in calculator.py, NOT inside the route):

**`_calculate_spouse_individual(spouse_data, filing_status, dependents, tax_year)`** -- Calculates one spouse's full tax using existing TaxCalculator methods:
  1. Convert income to annual via `TaxCalculator.convert_income_to_annual()`
  2. For S-Corp types (`llc_s_corp`, `s_corp`), use salary + distributions as annual_income
  3. Call `TaxCalculator.calculate_federal_tax(annual_income, filing_status, dependents, tax_year, income_source=..., salary=..., distributions=...)`
  4. If `state_code` provided, call `TaxCalculator.calculate_state_tax(income_for_state, filing_status, dependents, state_code, tax_year)`
  5. Return dict with `federal`, `state`, `annual_income`, and `totals` (federal_tax + state_tax, effective_rate)

**`_calculate_mfj_combined(husband_data, wife_data, dependents, tax_year)`** -- MFJ combined calculation:
  1. Convert both spouses' incomes to annual
  2. For S-Corp types, use salary + distributions
  3. Determine income_source for combined: if either has S-Corp, treat combined as complex. For simplicity, calculate the combined ordinary income using the following approach:
     - Get standard deduction: `TaxCalculator.get_standard_deduction('married_joint', 'federal', None, tax_year)`
     - Calculate combined QBI: sum QBI-eligible income from each spouse. QBI-eligible sources: `llc` (full income), `llc_s_corp` (distributions only), `s_corp` (distributions only). W2 has $0 QBI.
     - Calculate taxable income before QBI: `max(0, combined_income - standard_deduction)`
     - Calculate QBI deduction: `TaxCalculator.calculate_qbi_deduction(combined_qbi, taxable_before_qbi, 'married_joint', tax_year)`
     - Calculate taxable income: `max(0, combined_income - standard_deduction - qbi_deduction)`
     - Get MFJ brackets: `TaxCalculator.get_tax_brackets('federal', None, 'married_joint', tax_year)`
     - Calculate income tax: `TaxCalculator.calculate_tax_by_brackets(taxable_income, brackets)`
     - Apply child tax credit: `TaxCalculator.calculate_child_tax_credit(dependents, tax_year)`, subtract from income tax (non-refundable, min $0)
  4. FICA/SE per-individual (CRITICAL -- never combine):
     - Husband: if W2, FICA=0 (employer pays); if LLC, call `TaxCalculator.calculate_self_employment_tax(h_income, tax_year)`; if S-Corp type, call `TaxCalculator.calculate_fica_tax(h_salary, 'married_joint', tax_year)`
     - Wife: same logic independently
  5. State tax per-individual: call `TaxCalculator.calculate_state_tax()` for each spouse using their own income and state_code, with filing_status='married_joint'
  6. Build per-spouse breakdown dict:
     - husband_breakdown: { annual_income, income_source, federal_income_tax_share (note: "Joint return -- income tax is on combined income"), fica_tax, se_tax, state_tax, state_code }
     - wife_breakdown: same structure
  7. Build joint totals: { combined_income, standard_deduction, combined_qbi_deduction, taxable_income, income_tax, total_fica_se (sum of both), total_state_tax (sum of both), total_tax, effective_rate }
  8. Return { husband_breakdown, wife_breakdown, totals }

**Route logic for `calculate_dual_tax()`:**
  1. Parse JSON input, extract husband, wife, dependents, tax_year
  2. Always calculate MFJ: `mfj = _calculate_mfj_combined(husband, wife, dependents, tax_year)`
  3. Always calculate MFS: `mfs_h = _calculate_spouse_individual(husband, 'married_separate', dependents, tax_year)` and `mfs_w = _calculate_spouse_individual(wife, 'married_separate', 0, tax_year)` (dependents default to husband for MFS)
  4. Build comparison: { mfj_total_tax, mfs_combined_tax (mfs_h total + mfs_w total), savings (abs difference), recommended ('MFJ' or 'MFS'), reason string }
  5. Return JSON:
```json
{
  "success": true,
  "mfj": { "husband_breakdown": {...}, "wife_breakdown": {...}, "totals": {...} },
  "mfs_husband": { "federal": {...}, "state": {...}, "annual_income": ..., "totals": {...} },
  "mfs_wife": { "federal": {...}, "state": {...}, "annual_income": ..., "totals": {...} },
  "comparison": { "mfj_total_tax": ..., "mfs_combined_tax": ..., "savings": ..., "recommended": "MFJ", "reason": "..." }
}
```

IMPORTANT pitfalls to avoid:
- Do NOT apply MFJ standard deduction per spouse (it is ONE $32,200 deduction on combined income)
- Do NOT combine FICA/SE taxes -- always per-individual
- For W2 income_source, FICA tax is $0 in this calculator (employer pays; the existing calculate_federal_tax returns fica_tax: 0 for W2)
- QBI-eligible income for LLC = full income, for S-Corp types = distributions only, for W2 = $0
- Wrap entire route in try/except, return 400 on error
  </action>
  <verify>
Test with curl:
```bash
curl -s -X POST http://localhost:5555/api/calculator/calculate-dual \
  -H 'Content-Type: application/json' \
  -d '{"husband":{"income":150000,"income_frequency":"annual","income_source":"w2","salary":0,"distributions":0,"state_code":"CA"},"wife":{"income":80000,"income_frequency":"annual","income_source":"llc","salary":0,"distributions":0,"state_code":"NY"},"dependents":2,"tax_year":2026}' | python3 -m json.tool
```
Verify response has: success=true, mfj object with husband_breakdown/wife_breakdown/totals, mfs_husband, mfs_wife, comparison with recommended field. Verify mfj.totals.total_tax is a reasonable number (should be roughly $30k-$50k range for $230k combined income MFJ with 2 dependents).

Also test the existing endpoint still works (no regression):
```bash
curl -s -X POST http://localhost:5555/api/calculator/calculate \
  -H 'Content-Type: application/json' \
  -d '{"income":100000,"income_frequency":"annual","income_source":"w2","filing_status":"single","dependents":0,"tax_year":2026}' | python3 -m json.tool
```
  </verify>
  <done>
  - /api/calculator/calculate-dual returns structured MFJ + MFS + comparison response
  - MFJ uses combined income with ONE standard deduction
  - FICA/SE calculated per-individual
  - Existing /calculator/calculate endpoint unchanged
  - QBI handles mixed income sources (W2 spouse + LLC spouse)
  </done>
</task>

<task type="auto">
  <name>Task 2: Restructure calculator.html for dual-pane mode + CSS</name>
  <files>templates/calculator.html, static/css/style.css</files>
  <action>
**calculator.html changes:**

Restructure the form to separate shared controls from per-pane content. The page layout becomes:

1. Move Filing Status toggle and Dependents dropdown ABOVE the form into a new `calculator-shared-controls` div (outside the form tag, or at the top inside it).

2. Wrap the existing form fields (income, frequency, source, S-Corp fields, state, multiple states) in a `<div id="single-pane-form">` -- this is the existing single-pane layout shown for Single/HoH/QSS.

3. Add a `<div id="dual-pane-form" style="display: none;">` containing:
   ```html
   <div class="calculator-split-container" id="calc-split-container">
     <div id="husband-pane" class="spouse-calc-panel">
       <h4>Husband</h4>
       <!-- Income field with id="husband-income" -->
       <div class="form-group">
         <label for="husband-income">Income *</label>
         <div class="income-input-group">
           <input type="number" id="husband-income" step="0.01" min="0" placeholder="Enter income amount">
           <div class="frequency-toggle" data-spouse="husband">
             <button type="button" class="toggle-btn active" data-frequency="annual">Annual</button>
             <button type="button" class="toggle-btn" data-frequency="monthly">Monthly</button>
             <button type="button" class="toggle-btn" data-frequency="bi_monthly">Bi-Monthly</button>
             <button type="button" class="toggle-btn" data-frequency="bi_weekly">Bi-Weekly</button>
             <button type="button" class="toggle-btn" data-frequency="weekly">Weekly</button>
           </div>
         </div>
         <input type="hidden" id="husband-frequency" value="annual">
       </div>
       <!-- Income Source with id="husband-source" -->
       <div class="form-group">
         <label for="husband-source">Income Source *</label>
         <select id="husband-source">
           <option value="w2" selected>Employee (W2)</option>
           <option value="llc">LLC</option>
           <option value="llc_s_corp">LLC as an S-Corp</option>
           <option value="s_corp">S-Corp</option>
         </select>
       </div>
       <!-- S-Corp fields with id="husband-salary-group", id="husband-salary", id="husband-distributions" -->
       <div class="form-group" id="husband-salary-group" style="display: none;">
         <label>Salary and Distributions *</label>
         <div class="salary-distributions-inputs">
           <div class="form-group-inline">
             <label for="husband-salary">Salary:</label>
             <input type="number" id="husband-salary" step="0.01" min="0" placeholder="Enter salary amount">
           </div>
           <div class="form-group-inline">
             <label for="husband-distributions">Distributions (Calculated):</label>
             <input type="number" id="husband-distributions" step="0.01" min="0" readonly placeholder="Calculated automatically">
           </div>
         </div>
       </div>
       <!-- State with id="husband-state" -->
       <div class="form-group">
         <label for="husband-state">State</label>
         <select id="husband-state">
           <option value="">Select a state...</option>
         </select>
       </div>
     </div>
     <div id="wife-pane" class="spouse-calc-panel">
       <h4>Wife</h4>
       <!-- Same structure as husband pane but with wife- prefix on all IDs -->
       <!-- wife-income, wife-frequency, wife-source, wife-salary-group, wife-salary, wife-distributions, wife-state -->
       <!-- (mirror the exact same HTML as husband pane with wife- prefix) -->
     </div>
   </div>
</div>
   ```

4. Keep the Submit button and Results div BELOW both form sections (shared).

5. Add Split.js CDN script BEFORE calculator.js:
   ```html
   <script src="https://unpkg.com/split.js@1.6.5/dist/split.min.js"></script>
   <script src="{{ url_for('static', filename='js/calculator.js') }}"></script>
   ```

Important: The wife-pane HTML must be an exact mirror of husband-pane with `wife-` prefix on all IDs. Both panes have their own frequency-toggle with data-spouse attribute, their own source dropdown, their own S-Corp fields, and their own state dropdown.

**style.css changes:**

Add these styles at the end of the file (after existing calculator styles). Reuse the existing `.gutter` styles already defined for joint_analysis.

```css
/* Calculator Dual-Pane Layout */
.calculator-shared-controls {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
}

.calculator-split-container {
    display: flex;
    min-height: 400px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
}

.spouse-calc-panel {
    overflow-y: auto;
    padding: 1.5rem;
    background: white;
    min-width: 0;
}

.spouse-calc-panel h4 {
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #3498db;
    color: #2c3e50;
    font-size: 1.1rem;
}

/* Dual results grid */
.dual-results-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.spouse-result-card {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.spouse-result-card h4 {
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #3498db;
    color: #2c3e50;
}

/* Comparison section */
.comparison-section {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-top: 1rem;
}

.comparison-section h4 {
    margin-bottom: 1rem;
    color: #2c3e50;
}

.comparison-table {
    width: 100%;
    border-collapse: collapse;
}

.comparison-table th,
.comparison-table td {
    padding: 0.75rem 1rem;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.comparison-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #2c3e50;
}

.comparison-recommended {
    background: #d4edda;
    font-weight: 600;
    color: #155724;
    padding: 0.75rem 1rem;
    border-radius: 4px;
    margin-top: 1rem;
    text-align: center;
}

.comparison-savings {
    font-size: 1.2rem;
    font-weight: bold;
    color: #27ae60;
}

/* Responsive: stack panes on mobile */
@media (max-width: 768px) {
    .calculator-split-container {
        flex-direction: column;
    }
    .spouse-calc-panel {
        width: 100% !important;
    }
    .dual-results-grid {
        grid-template-columns: 1fr;
    }
}
```

Do NOT remove or modify any existing CSS rules. Only append new rules.
  </action>
  <verify>
Open http://localhost:5555/calculator.html in browser:
1. Verify page loads showing single-pane form (Single filing status active by default)
2. Verify dual-pane-form div exists in DOM but is hidden (display: none)
3. Inspect that husband-pane and wife-pane both have correct form fields (income, frequency toggle, source, S-Corp fields, state)
4. Verify Split.js CDN script tag is present before calculator.js
5. Verify existing single-pane form still looks correct (no visual regression)
  </verify>
  <done>
  - calculator.html has shared-controls section (filing status + dependents) above form
  - single-pane-form div wraps existing single fields, visible by default
  - dual-pane-form div with husband/wife panes, hidden by default
  - Each spouse pane has: income, frequency toggle, source dropdown, S-Corp salary/distributions, state dropdown
  - All IDs use husband-/wife- prefix for independent control
  - Split.js CDN loaded before calculator.js
  - CSS styles for calculator split layout and dual results display added
  - No regression on existing styles
  </done>
</task>

</tasks>

<verification>
1. `curl -X POST /api/calculator/calculate-dual` returns valid JSON with mfj, mfs_husband, mfs_wife, comparison
2. `curl -X POST /api/calculator/calculate` still works (no regression)
3. calculator.html loads without JS errors
4. DOM has both single-pane-form and dual-pane-form sections
5. CSS styles render correctly (no layout breaks)
</verification>

<success_criteria>
- CALC-01/02 structural foundation: Dual-pane HTML exists for MFJ/MFS modes
- CALC-03/04/05: Each spouse pane has income fields, S-Corp fields, independent state selection
- CALC-06 foundation: Single-pane form preserved, visible by default
- RSLT-01/02/03 backend: API returns per-spouse breakdowns, joint totals, and MFJ vs MFS comparison
- Backend is curl-testable independently of frontend JS
</success_criteria>

<output>
After completion, create `.planning/phases/05-calculator-dual-pane/05-01-SUMMARY.md`
</output>
