---
phase: 05-calculator-dual-pane
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - static/js/calculator.js
autonomous: false

must_haves:
  truths:
    - "Clicking MFJ or MFS toggle transforms calculator to dual-pane view with husband (left) and wife (right)"
    - "Clicking Single/HoH/QSS toggles back to single-pane view (no regression)"
    - "Each spouse pane has independent income field, frequency toggle, source dropdown, and state dropdown"
    - "Selecting S-Corp/LLC S-Corp income source in a spouse pane shows salary/distributions fields for THAT pane only"
    - "Submitting dual-pane form calls /calculate-dual and displays per-spouse breakdown, joint totals, and MFJ vs MFS comparison"
    - "Split.js provides resizable drag handle between husband and wife panes"
    - "Toggling between filing statuses does not create multiple Split.js instances"
    - "Single-pane submission still calls existing /calculate endpoint and displays results correctly"
  artifacts:
    - path: "static/js/calculator.js"
      provides: "All calculator interactivity: filing status toggle, dual-pane logic, form submission, results display"
      min_lines: 500
  key_links:
    - from: "static/js/calculator.js"
      to: "/api/calculator/calculate-dual"
      via: "fetch POST in calculateDualTax()"
      pattern: "calculator/calculate-dual"
    - from: "static/js/calculator.js"
      to: "/api/calculator/calculate"
      via: "fetch POST in calculateTax() (existing)"
      pattern: "calculator/calculate"
    - from: "static/js/calculator.js"
      to: "templates/calculator.html"
      via: "DOM element IDs (husband-income, wife-income, single-pane-form, dual-pane-form, etc.)"
      pattern: "getElementById.*husband|getElementById.*wife|getElementById.*single-pane|getElementById.*dual-pane"
---

<objective>
Write the complete calculator.js with dual-pane mode support: filing status toggle transforms the form, Split.js manages resizable panes, each spouse pane has independent form controls, dual submission calls /calculate-dual, and results display shows per-spouse breakdown with MFJ vs MFS comparison.

Purpose: This is the interactive layer that makes the dual-pane calculator functional. It connects the HTML structure (from 05-01) to the backend API (from 05-01) with all user interaction logic.

Output: Complete rewrite of static/js/calculator.js (~600-800 lines) covering single-pane (existing behavior preserved) and dual-pane (new MFJ/MFS mode).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-calculator-dual-pane/05-RESEARCH.md
@.planning/phases/05-calculator-dual-pane/05-01-SUMMARY.md

# Key source files
@static/js/calculator.js
@static/js/joint_analysis.js
@templates/calculator.html
@routes/calculator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite calculator.js with dual-pane support</name>
  <files>static/js/calculator.js</files>
  <action>
Write the COMPLETE calculator.js file in one pass (do not incrementally edit -- per learnings, full file rewrite works better). The file must handle both single-pane (existing behavior) and dual-pane (new MFJ/MFS) modes.

**File structure (sections in order):**

### 1. Constants and State
```javascript
const API_BASE = '/api';
let states = [];
let selectedStates = [];      // For single-pane multiple states
let currentFrequency = 'annual';  // Single-pane frequency
let calcSplitInstance = null;  // Split.js instance
let husbandFrequency = 'annual';  // Dual-pane husband frequency
let wifeFrequency = 'annual';     // Dual-pane wife frequency

const FREQUENCY_FACTORS = {
    'annual': 1.0,
    'monthly': 12.0,
    'bi_monthly': 24.0,
    'bi_weekly': 26.0,
    'weekly': 52.0
};
```

### 2. DOMContentLoaded
- Call `loadStates()` (populates BOTH single-pane and dual-pane state dropdowns)
- Call `setupEventListeners()`

### 3. loadStates()
Same as existing but ALSO populate `husband-state` and `wife-state` dropdowns (in addition to `state-select` and `add-state-select`).

### 4. setupEventListeners()
Preserve ALL existing event listeners for single-pane mode (frequency toggle, income source, filing status, multiple states, salary/distributions auto-calc, form submit).

Add NEW listeners:
- **Dual-pane frequency toggles:** For each `.frequency-toggle[data-spouse]` button, handle frequency conversion for that spouse's income field. Use `data-spouse` attribute to determine which pane (husband/wife).
- **Dual-pane income source change:** `husband-source` and `wife-source` change events call a new `handleSpouseIncomeSourceChange(prefix)` function.
- **Dual-pane salary/income inputs:** For S-Corp types, auto-calculate distributions per spouse (husband-income + husband-salary -> husband-distributions, same for wife).

The key filing status handler must call `handleFilingStatusChange(status)` which is UPDATED (see below).

### 5. handleFilingStatusChange(status) -- UPDATED
This is the core transformation logic:
```javascript
function handleFilingStatusChange(status) {
    // Update toggle buttons (existing logic -- mark active button)
    document.querySelectorAll('.filing-status-toggle .toggle-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.status === status) btn.classList.add('active');
    });
    document.getElementById('filing-status').value = status;

    const isDualPane = (status === 'married_joint' || status === 'married_separate');
    const singleForm = document.getElementById('single-pane-form');
    const dualForm = document.getElementById('dual-pane-form');

    if (isDualPane) {
        singleForm.style.display = 'none';
        dualForm.style.display = 'block';
        initCalculatorSplit();
    } else {
        singleForm.style.display = 'block';
        dualForm.style.display = 'none';
        destroyCalculatorSplit();
    }
}
```

### 6. Split.js Management
Follow the exact pattern from joint_analysis.js (lines 44-100):
```javascript
function initCalculatorSplit() {
    if (calcSplitInstance) return;  // Already initialized
    if (typeof Split === 'undefined') return;
    if (window.innerWidth <= 768) return;  // Mobile: stack vertically

    let sizes = [50, 50];
    const saved = localStorage.getItem('calculatorSplitSizes');
    if (saved) {
        try { sizes = JSON.parse(saved); } catch (e) { /* defaults */ }
    }

    calcSplitInstance = Split(['#husband-pane', '#wife-pane'], {
        sizes: sizes,
        minSize: 280,
        gutterSize: 10,
        cursor: 'col-resize',
        onDragEnd: function(sizes) {
            localStorage.setItem('calculatorSplitSizes', JSON.stringify(sizes));
        }
    });
}

function destroyCalculatorSplit() {
    if (calcSplitInstance) {
        calcSplitInstance.destroy();
        calcSplitInstance = null;
    }
}
```

Add resize handler (debounced) to destroy/recreate split at 768px breakpoint, same pattern as joint_analysis.js.

### 7. Per-Spouse Form Logic

**`handleSpouseIncomeSourceChange(prefix)`** -- prefix is 'husband' or 'wife':
- Get the source value from `document.getElementById(prefix + '-source')`
- Show/hide `document.getElementById(prefix + '-salary-group')` based on S-Corp types
- Same logic as existing `handleIncomeSourceChange()` but uses prefixed IDs

**`handleSpouseFrequencyChange(prefix, frequency)`** -- prefix is 'husband' or 'wife':
- Convert income value in `prefix + '-income'` from old frequency to new
- Update active button within that pane's `.frequency-toggle[data-spouse="${prefix}"]`
- Update hidden field `prefix + '-frequency'`
- Update the tracking variable (husbandFrequency or wifeFrequency)
- If S-Corp type, recalculate distributions for that spouse

**`calculateSpouseDistributions(prefix)`** -- prefix is 'husband' or 'wife':
- Read income from `prefix + '-income'`
- Read frequency from `prefix + '-frequency'`
- Read salary from `prefix + '-salary'`
- Convert income to annual, subtract salary, set `prefix + '-distributions'`
- Same logic as existing `calculateDistributions()` but with prefixed IDs

### 8. Form Submission -- Modified
Modify the form submit handler to detect mode:
```javascript
form.addEventListener('submit', (e) => {
    e.preventDefault();
    const filingStatus = document.getElementById('filing-status').value;
    const isDualPane = (filingStatus === 'married_joint' || filingStatus === 'married_separate');
    if (isDualPane) {
        calculateDualTax();
    } else {
        calculateTax();  // Existing single-pane logic, UNCHANGED
    }
});
```

### 9. calculateDualTax() -- NEW
```javascript
async function calculateDualTax() {
    const filingStatus = document.getElementById('filing-status').value;
    const dependents = parseInt(document.getElementById('dependents').value) || 0;

    const husband = gatherSpouseData('husband');
    const wife = gatherSpouseData('wife');

    // Validation
    if (!validateSpouseData(husband, 'Husband')) return;
    if (!validateSpouseData(wife, 'Wife')) return;

    try {
        const response = await fetch(`${API_BASE}/calculator/calculate-dual`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                filing_status: filingStatus,
                husband: husband,
                wife: wife,
                dependents: dependents,
                tax_year: 2026
            })
        });

        const result = await response.json();
        if (result.success) {
            displayDualResults(result);
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error calculating dual tax:', error);
        alert('Failed to calculate tax. Please try again.');
    }
}
```

**`gatherSpouseData(prefix)`:**
```javascript
function gatherSpouseData(prefix) {
    return {
        income: parseFloat(document.getElementById(prefix + '-income').value) || 0,
        income_frequency: document.getElementById(prefix + '-frequency').value || 'annual',
        income_source: document.getElementById(prefix + '-source').value || 'w2',
        salary: parseFloat(document.getElementById(prefix + '-salary').value) || 0,
        distributions: parseFloat(document.getElementById(prefix + '-distributions').value) || 0,
        state_code: document.getElementById(prefix + '-state').value || null
    };
}
```

**`validateSpouseData(data, label)`:**
- If S-Corp type: validate salary > 0, salary <= annual income
- Else: validate income > 0
- Show alert with label prefix (e.g., "Husband: Please enter a valid income")
- Return true/false

### 10. calculateTax() -- EXISTING (preserve exactly)
Keep the entire existing `calculateTax()` function unchanged. It handles single-pane submission.

### 11. displayDualResults(result) -- NEW
Build HTML for dual results display and set as innerHTML of `calculator-results`:

**Structure:**
```html
<!-- Results Header -->
<div class="results-header">
    <h3>Dual Tax Calculation Results</h3>
</div>

<!-- Per-Spouse MFJ Breakdown (RSLT-01) -->
<div class="dual-results-grid">
    <div class="spouse-result-card">
        <h4>Husband - MFJ Breakdown</h4>
        <!-- annual_income, income_source label, state, FICA/SE tax, state tax -->
        <!-- Note: federal income tax is combined (cannot split per-spouse on MFJ) -->
    </div>
    <div class="spouse-result-card">
        <h4>Wife - MFJ Breakdown</h4>
        <!-- Same structure -->
    </div>
</div>

<!-- Joint MFJ Totals (RSLT-02) -->
<div class="result-card totals-card">
    <h4>Joint Total - Married Filing Jointly (MFJ)</h4>
    <!-- combined_income, standard_deduction, qbi_deduction, taxable_income -->
    <!-- income_tax, total_fica_se, total_state_tax, total_tax, effective_rate -->
</div>

<!-- MFS Breakdown -->
<div class="dual-results-grid">
    <div class="spouse-result-card">
        <h4>Husband - MFS Individual</h4>
        <!-- Use mfs_husband.federal and mfs_husband.state data -->
        <!-- Show federal tax, state tax, total, effective rate -->
    </div>
    <div class="spouse-result-card">
        <h4>Wife - MFS Individual</h4>
        <!-- Use mfs_wife.federal and mfs_wife.state data -->
    </div>
</div>

<!-- MFJ vs MFS Comparison (RSLT-03) -->
<div class="comparison-section">
    <h4>Filing Status Comparison</h4>
    <table class="comparison-table">
        <thead>
            <tr><th></th><th>MFJ</th><th>MFS Combined</th></tr>
        </thead>
        <tbody>
            <tr><td>Federal Tax</td><td>$X</td><td>$Y</td></tr>
            <tr><td>State Tax</td><td>$X</td><td>$Y</td></tr>
            <tr><td>FICA/SE Tax</td><td>$X</td><td>$Y</td></tr>
            <tr><td><strong>Total Tax</strong></td><td><strong>$X</strong></td><td><strong>$Y</strong></td></tr>
        </tbody>
    </table>
    <div class="comparison-recommended">
        Recommended: {result.comparison.recommended} -- Saves {formatCurrency(result.comparison.savings)}
    </div>
</div>
```

Use `formatCurrency()` and `formatPercentage()` (existing helpers, keep them).

For the per-spouse MFJ cards, display:
- Annual Income
- Income Source (W2/LLC/S-Corp label)
- State
- FICA Tax or SE Tax (whichever applies based on income source)
- State Tax (from their individual state)
- Note: "Federal income tax is calculated on combined income (see Joint Total below)"

For the MFS cards, display the full federal breakdown using the same pattern as existing `displayResults()` single federal card. Reuse the existing display template logic or create a helper `renderFederalBreakdown(federal)` that outputs the same HTML.

### 12. displayResults() -- EXISTING (preserve exactly)
Keep the entire existing `displayResults()` function unchanged. It handles single-pane results.

### 13. Utility Functions -- EXISTING (preserve)
Keep `formatCurrency()`, `formatPercentage()` unchanged.
Keep all existing multi-state functions (`handleMultipleStatesChange`, `addSelectedState`, `removeSelectedState`, `updateSelectedStatesList`).
Keep existing `calculateDistributions()`, `handleIncomeSourceChange()`, `handleIncomeFrequencyChange()`.

**CRITICAL: Do NOT break existing single-pane behavior.** Every existing function must remain functional. The dual-pane code is purely additive.

**Write the entire file in one pass.** Do not use incremental edits. Read the current file, understand it fully, then write the complete new version.
  </action>
  <verify>
Test in browser at http://localhost:5555/calculator.html:

1. **Single-pane (no regression):**
   - Page loads with Single filing status active, single-pane form visible
   - Enter $100,000 annual W2 income, Single filing, California
   - Click Analyze -- results display with federal + state breakdown
   - Verify numbers match existing behavior

2. **Dual-pane activation:**
   - Click "MFJ" filing status toggle
   - Single-pane form hides, dual-pane form appears
   - Split.js drag handle visible between husband and wife panes
   - Drag handle works (resizes panes)

3. **Per-spouse independence:**
   - Set husband to W2, wife to LLC
   - Verify wife's S-Corp fields stay hidden, husband's stay hidden
   - Change wife to S-Corp -- salary/distributions fields appear ONLY in wife pane
   - Set husband state to CA, wife state to NY -- independent selections

4. **Dual-pane submission:**
   - Husband: $150,000 annual W2, CA
   - Wife: $80,000 annual LLC, NY
   - 2 dependents
   - Click Analyze
   - Results show: per-spouse MFJ breakdown, Joint MFJ totals, per-spouse MFS breakdown, MFJ vs MFS comparison
   - Comparison shows recommended filing status with savings amount

5. **Filing status toggle:**
   - Switch back to "Single" -- dual-pane hides, single-pane reappears, Split.js destroyed
   - Switch to "MFJ" again -- dual-pane reappears, Split.js re-initialized (no duplicate gutters)
   - Switch to "HoH" -- single-pane shows
   - Switch to "MFS" -- dual-pane shows

6. **Frequency toggle per spouse:**
   - Enter $150,000 annual for husband
   - Click "Monthly" -- value converts to $12,500
   - Wife's income field unchanged

7. **S-Corp distributions auto-calc:**
   - Set husband to S-Corp, enter $200,000 income, $100,000 salary
   - Distributions auto-calculates to $100,000
   - Wife's fields unaffected
  </verify>
  <done>
  - CALC-01: MFJ shows split-screen husband/wife
  - CALC-02: MFS shows split-screen husband/wife
  - CALC-03: Each pane has income fields with amount, frequency toggle, source dropdown
  - CALC-04: Each pane shows salary/distributions when S-Corp selected
  - CALC-05: Each pane has independent state selection
  - CALC-06: Single/HoH/QSS retain single-pane (no regression)
  - RSLT-01: Per-spouse tax breakdown displayed
  - RSLT-02: Joint totals displayed
  - RSLT-03: MFJ vs MFS comparison with recommended filing status and savings
  - Split.js properly initialized/destroyed on toggle
  - Existing single-pane calculateTax() and displayResults() unchanged
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete dual-pane calculator with MFJ/MFS mode, per-spouse inputs, and comparison results</what-built>
  <how-to-verify>
  Visit http://localhost:5555/calculator.html and test these scenarios:

  **Test 1: Single pane still works**
  1. Page loads with Single filing status
  2. Enter $100,000 W2, Single, CA, 0 dependents
  3. Click Analyze -- verify results appear with federal + state breakdown
  4. Expected: ~$13,800 federal, ~$5,500 CA state

  **Test 2: MFJ dual-pane basic**
  1. Click "MFJ" toggle
  2. Verify split-screen appears with Husband (left) and Wife (right)
  3. Husband: $150,000 W2, CA
  4. Wife: $80,000 W2, NY
  5. Dependents: 2
  6. Click Analyze
  7. Verify: per-spouse breakdown, joint totals, MFJ vs MFS comparison

  **Test 3: MFS dual-pane**
  1. Click "MFS" toggle
  2. Same data as above
  3. Click Analyze
  4. Verify: results show and comparison indicates whether MFJ or MFS saves more

  **Test 4: Mixed income sources**
  1. MFJ mode
  2. Husband: $200,000 S-Corp, $100,000 salary (distributions auto-calc to $100,000), CA
  3. Wife: $80,000 LLC, NY
  4. Dependents: 1
  5. Click Analyze
  6. Verify: Results show FICA for husband (S-Corp salary), SE tax for wife (LLC), QBI for both

  **Test 5: Toggle stress test**
  1. Click through: Single -> MFJ -> Single -> MFS -> HoH -> MFJ -> Single
  2. Verify: No duplicate gutters, no JS errors in console, clean transitions
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues you see</resume-signal>
</task>

</tasks>

<verification>
1. Single-pane calculator works identically to before (no regression)
2. MFJ/MFS filing status toggle activates dual-pane view
3. Each spouse pane has independent form controls
4. S-Corp fields show/hide independently per pane
5. Dual submission calls /calculate-dual and displays results
6. Results show per-spouse breakdown, joint totals, and MFJ vs MFS comparison
7. Split.js initializes/destroys cleanly on toggle
8. No JS console errors
</verification>

<success_criteria>
All 9 requirements met:
- CALC-01: MFJ split-screen with husband/wife panes
- CALC-02: MFS split-screen with husband/wife panes
- CALC-03: Per-spouse income fields (amount, frequency, source)
- CALC-04: Per-spouse S-Corp salary/distributions
- CALC-05: Per-spouse independent state selection
- CALC-06: Single/HoH/QSS single-pane (no regression)
- RSLT-01: Per-spouse tax breakdown (federal, state, effective rate)
- RSLT-02: Joint totals (combined federal, state, total)
- RSLT-03: MFJ vs MFS comparison with recommendation
</success_criteria>

<output>
After completion, create `.planning/phases/05-calculator-dual-pane/05-02-SUMMARY.md`
</output>
